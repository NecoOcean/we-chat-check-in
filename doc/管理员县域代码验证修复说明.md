# ç®¡ç†å‘˜å¿åŸŸä»£ç éªŒè¯ä¿®å¤è¯´æ˜

**æ—¥æœŸï¼š** 2025-11-01  
**ç‰ˆæœ¬ï¼š** v1.2.0 Hotfix  
**é—®é¢˜ï¼š** æ›´æ–°ç®¡ç†å‘˜ä¿¡æ¯æ—¶è¿åå¤–é”®çº¦æŸ  
**çŠ¶æ€ï¼š** âœ… **å·²ä¿®å¤**  

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ç°è±¡

```
Cannot add or update a child row: a foreign key constraint fails 
(`we_chat_checkin_dev`.`admins`, CONSTRAINT `fk_admins_county_code` 
FOREIGN KEY (`county_code`) REFERENCES `counties` (`code`) 
ON DELETE RESTRICT ON UPDATE CASCADE)
```

### æ ¹æœ¬åŸå› 

åœ¨åˆ›å»ºæˆ–æ›´æ–°ç®¡ç†å‘˜ä¿¡æ¯æ—¶ï¼Œå¦‚æœæä¾›çš„ `county_code` åœ¨ `counties` è¡¨ä¸­ä¸å­˜åœ¨ï¼Œä¼šè§¦å‘æ•°æ®åº“çš„å¤–é”®çº¦æŸé”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºï¼š

1. `admins` è¡¨çš„ `county_code` å­—æ®µæ˜¯å¤–é”®ï¼Œå¼•ç”¨ `counties.code`
2. ä¸šåŠ¡ä»£ç åœ¨æ’å…¥/æ›´æ–°å‰æ²¡æœ‰éªŒè¯å¿åŸŸä»£ç çš„æœ‰æ•ˆæ€§
3. å¯¼è‡´ç›´æ¥åœ¨æ•°æ®åº“å±‚é¢æŠ›å‡º `SQLIntegrityConstraintViolationException`

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¸âƒ£: åœ¨ AdminMapper ä¸­æ·»åŠ å¿åŸŸä»£ç éªŒè¯æ–¹æ³•

**æ–‡ä»¶ï¼š** `backend/we-chat-auth/src/main/java/com/wechat/checkin/auth/mapper/AdminMapper.java`

```java
/**
 * æ£€æŸ¥å¿åŸŸä»£ç æ˜¯å¦å­˜åœ¨
 *
 * @param countyCode å¿åŸŸä»£ç 
 * @return æ˜¯å¦å­˜åœ¨
 */
@Select("SELECT COUNT(*) > 0 FROM counties WHERE code = #{countyCode} AND status != 'deleted'")
boolean existsCountyCode(@Param("countyCode") String countyCode);
```

### ä¿®å¤2ï¸âƒ£: åœ¨åˆ›å»ºç®¡ç†å‘˜æ—¶æ·»åŠ å¿åŸŸéªŒè¯

**æ–‡ä»¶ï¼š** `backend/we-chat-admin/src/main/java/com/wechat/checkin/admin/service/impl/AdminServiceImpl.java`

**createAdmin æ–¹æ³•ï¼š**

```java
// 2. å¦‚æœæ˜¯å¿çº§ç®¡ç†å‘˜ï¼ŒéªŒè¯å¿åŸŸä»£ç æ˜¯å¦å­˜åœ¨
if ("county".equals(request.getRole()) && StringUtils.hasText(request.getCountyCode())) {
    if (!adminMapper.existsCountyCode(request.getCountyCode())) {
        throw new BusinessException(ResultCode.COUNTY_CODE_NOT_FOUND);
    }
}
```

### ä¿®å¤3ï¸âƒ£: åœ¨æ›´æ–°ç®¡ç†å‘˜æ—¶æ·»åŠ å¿åŸŸéªŒè¯

**updateAdmin æ–¹æ³•ï¼š**

```java
// 4. æ›´æ–°å¿åŸŸä»£ç ï¼ˆå¦‚æœæä¾›ï¼‰
if (StringUtils.hasText(request.getCountyCode())) {
    // éªŒè¯å¿åŸŸä»£ç æ˜¯å¦å­˜åœ¨
    if (!adminMapper.existsCountyCode(request.getCountyCode())) {
        throw new BusinessException(ResultCode.COUNTY_CODE_NOT_FOUND);
    }
    admin.setCountyCode(request.getCountyCode());
}
```

### ä¿®å¤4ï¸âƒ£: æ·»åŠ é”™è¯¯ç 

**æ–‡ä»¶ï¼š** `backend/we-chat-common/src/main/java/com/wechat/checkin/common/response/ResultCode.java`

```java
COUNTY_CODE_NOT_FOUND(1109, "å¿åŸŸä»£ç ä¸å­˜åœ¨"),
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

- âŒ ä½¿ç”¨ä¸å­˜åœ¨çš„å¿åŸŸä»£ç æ—¶ï¼ŒæŠ›å‡ºæ•°æ®åº“å±‚é¢çš„ `SQLIntegrityConstraintViolationException`
- âŒ é”™è¯¯ä¿¡æ¯å¯¹ç”¨æˆ·ä¸å‹å¥½ï¼Œæš´éœ²æ•°æ®åº“ç»“æ„
- âŒ 500 å†…éƒ¨æœåŠ¡å™¨é”™è¯¯

### ä¿®å¤å

- âœ… åœ¨ä¸šåŠ¡å±‚æå‰éªŒè¯å¿åŸŸä»£ç çš„æœ‰æ•ˆæ€§
- âœ… è¿”å›å‹å¥½çš„é”™è¯¯æç¤ºï¼š"å¿åŸŸä»£ç ä¸å­˜åœ¨"ï¼ˆ1109ï¼‰
- âœ… 400 ä¸šåŠ¡é”™è¯¯ï¼Œå‰ç«¯å¯ä»¥æ­£ç¡®å¤„ç†
- âœ… é¿å…ä¸å¿…è¦çš„æ•°æ®åº“æ“ä½œ

---

## ğŸ“‹ éªŒè¯æ­¥éª¤

### 1. ç¡®ä¿æ•°æ®åº“ä¸­æœ‰å¿åŸŸæ•°æ®

```sql
-- æŸ¥è¯¢ç°æœ‰å¿åŸŸ
SELECT * FROM counties WHERE status = 'enabled';

-- å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO counties (code, name, status) VALUES 
('PX', 'èä¹¡å¿', 'enabled'),
('YJ', 'å®œæ˜¥å¿', 'enabled');
```

### 2. æµ‹è¯•åˆ›å»ºå¿çº§ç®¡ç†å‘˜

**æ­£å¸¸æƒ…å†µï¼š**

```json
POST /api/admins
{
    "username": "PXadmin",
    "password": "123456",
    "role": "county",
    "countyCode": "PX"
}
```

**é¢„æœŸå“åº”ï¼š** 200 OKï¼Œè¿”å›ç®¡ç†å‘˜ID

**å¼‚å¸¸æƒ…å†µï¼š**

```json
POST /api/admins
{
    "username": "XXadmin",
    "password": "123456",
    "role": "county",
    "countyCode": "XX"  // ä¸å­˜åœ¨çš„å¿åŸŸä»£ç 
}
```

**é¢„æœŸå“åº”ï¼š**

```json
{
    "code": 1109,
    "message": "å¿åŸŸä»£ç ä¸å­˜åœ¨",
    "timestamp": 1730438400000
}
```

### 3. æµ‹è¯•æ›´æ–°ç®¡ç†å‘˜

**æ­£å¸¸æƒ…å†µï¼š**

```json
PUT /api/admins/1
{
    "username": "PXadmin",
    "countyCode": "YJ"  // æ›´æ–°ä¸ºå…¶ä»–å­˜åœ¨çš„å¿åŸŸ
}
```

**é¢„æœŸå“åº”ï¼š** 200 OK

**å¼‚å¸¸æƒ…å†µï¼š**

```json
PUT /api/admins/1
{
    "username": "PXadmin",
    "countyCode": "INVALID"  // ä¸å­˜åœ¨çš„å¿åŸŸä»£ç 
}
```

**é¢„æœŸå“åº”ï¼š**

```json
{
    "code": 1109,
    "message": "å¿åŸŸä»£ç ä¸å­˜åœ¨",
    "timestamp": 1730438400000
}
```

---

## ğŸ” æŠ€æœ¯è¦ç‚¹

### 1. å¤–é”®çº¦æŸçš„å¤„ç†

- **æ•°æ®åº“å±‚é¢**ï¼šé€šè¿‡å¤–é”®çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§
- **åº”ç”¨å±‚é¢**ï¼šåœ¨ä¸šåŠ¡é€»è¾‘ä¸­æå‰éªŒè¯ï¼Œæä¾›å‹å¥½é”™è¯¯æç¤º
- **åŒé‡ä¿æŠ¤**ï¼šæ—¢ä¿è¯æ•°æ®å®Œæ•´æ€§ï¼Œåˆæä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ

### 2. éªŒè¯æ—¶æœº

- **åˆ›å»ºæ—¶**ï¼šä»…åœ¨ `role = 'county'` ä¸”æä¾›äº† `countyCode` æ—¶éªŒè¯
- **æ›´æ–°æ—¶**ï¼šä»…åœ¨æä¾›äº†æ–°çš„ `countyCode` æ—¶éªŒè¯
- **æŸ¥è¯¢æ¡ä»¶**ï¼šéªŒè¯æ—¶æ’é™¤å·²è½¯åˆ é™¤çš„å¿åŸŸï¼ˆ`status != 'deleted'`ï¼‰

### 3. é”™è¯¯å¤„ç†

- **ç»Ÿä¸€å¼‚å¸¸**ï¼šä½¿ç”¨ `BusinessException` ç»Ÿä¸€å¤„ç†ä¸šåŠ¡å¼‚å¸¸
- **é”™è¯¯ç è§„èŒƒ**ï¼šä½¿ç”¨ 11xx ç³»åˆ—è¡¨ç¤ºç”¨æˆ·ç›¸å…³é”™è¯¯
- **å…¨å±€å¤„ç†**ï¼šé€šè¿‡ `GlobalExceptionHandler` ç»Ÿä¸€è¿”å›æ ¼å¼

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶

1. `backend/we-chat-auth/src/main/java/com/wechat/checkin/auth/mapper/AdminMapper.java`
2. `backend/we-chat-admin/src/main/java/com/wechat/checkin/admin/service/impl/AdminServiceImpl.java`
3. `backend/we-chat-common/src/main/java/com/wechat/checkin/common/response/ResultCode.java`

### æ¶‰åŠçš„æ•°æ®åº“è¡¨

- `counties`ï¼šå¿åŸŸè¡¨ï¼ˆä¸»è¡¨ï¼‰
- `admins`ï¼šç®¡ç†å‘˜è¡¨ï¼ˆä»è¡¨ï¼Œé€šè¿‡ `county_code` å¤–é”®å¼•ç”¨ `counties.code`ï¼‰

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. å¤–é”®çº¦æŸéªŒè¯åŸåˆ™

- âœ… **åº”ç”¨å±‚ä¼˜å…ˆéªŒè¯**ï¼šåœ¨ä¸šåŠ¡ä»£ç ä¸­éªŒè¯å¤–é”®çš„æœ‰æ•ˆæ€§
- âœ… **å‹å¥½é”™è¯¯æç¤º**ï¼šè¿”å›ä¸šåŠ¡å±‚é¢çš„é”™è¯¯ä¿¡æ¯ï¼Œè€Œéæ•°æ®åº“å¼‚å¸¸
- âœ… **ä¿ç•™æ•°æ®åº“çº¦æŸ**ï¼šä½œä¸ºæœ€åä¸€é“é˜²çº¿ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§

### 2. éªŒè¯é€»è¾‘è®¾è®¡

- âœ… **æŒ‰éœ€éªŒè¯**ï¼šä»…åœ¨éœ€è¦æ—¶éªŒè¯ï¼ˆå¦‚å¿çº§ç®¡ç†å‘˜æ‰éªŒè¯å¿åŸŸä»£ç ï¼‰
- âœ… **æ’é™¤è½¯åˆ é™¤**ï¼šéªŒè¯æ—¶æ’é™¤å·²åˆ é™¤çš„è®°å½•
- âœ… **æå‰éªŒè¯**ï¼šåœ¨æ•°æ®åº“æ“ä½œå‰å®Œæˆæ‰€æœ‰éªŒè¯

### 3. é”™è¯¯ç è®¾è®¡

- âœ… **åˆ†ç±»æ¸…æ™°**ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—åˆ’åˆ†é”™è¯¯ç åŒºé—´
- âœ… **è¯­ä¹‰æ˜ç¡®**ï¼šé”™è¯¯ç åç§°å’Œæç¤ºä¿¡æ¯æ¸…æ™°æ˜äº†
- âœ… **æ˜“äºæ‰©å±•**ï¼šé¢„ç•™è¶³å¤Ÿçš„é”™è¯¯ç ç©ºé—´

---

## âœ¨ æ€»ç»“

æœ¬æ¬¡ä¿®å¤é€šè¿‡åœ¨ä¸šåŠ¡å±‚æ·»åŠ å¿åŸŸä»£ç éªŒè¯ï¼Œå®ç°äº†ï¼š

1. **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**ï¼šè¿”å›å‹å¥½çš„é”™è¯¯æç¤ºï¼Œè€Œéæ•°æ®åº“å¼‚å¸¸
2. **æ›´æ—©çš„é”™è¯¯å‘ç°**ï¼šåœ¨ä¸šåŠ¡é€»è¾‘å±‚å°±èƒ½å‘ç°å¹¶å¤„ç†é—®é¢˜
3. **æ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯**ï¼šæ˜ç¡®å‘ŠçŸ¥å¿åŸŸä»£ç ä¸å­˜åœ¨ï¼Œä¾¿äºå‰ç«¯å¤„ç†
4. **ä¿æŒæ•°æ®å®Œæ•´æ€§**ï¼šæ•°æ®åº“çº¦æŸä½œä¸ºæœ€åé˜²çº¿ä¾ç„¶ä¿ç•™

è¿™ç§è®¾è®¡éµå¾ªäº†"é˜²å¾¡æ€§ç¼–ç¨‹"çš„æœ€ä½³å®è·µï¼Œæ—¢ä¿è¯äº†æ•°æ®å®Œæ•´æ€§ï¼Œåˆæä¾›äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚


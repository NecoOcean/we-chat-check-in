# 活动评价模块（we-chat-evaluation）测试用例

## 测试环境

- **后端**：Spring Boot 3.5.7 + Java 17
- **数据库**：MySQL 8.0+
- **API 文档**：Swagger UI (http://localhost:8080/swagger-ui.html)

## 前置条件

1. 应用已启动，监听端口 8080
2. 数据库已初始化，所有表已创建
3. 已有测试数据：活动、教学点、打卡记录
4. 获取有效的 JWT Token 用于登录接口

## 测试用例

### 模块 1：评价提交接口 (`POST /api/evaluations/evaluation`)

#### TC-1.1: 正常提交评价
**目标**：验证正常评价提交流程
**前置条件**：
- 活动已结束（status = 'ended'）
- 评价二维码有效且未过期
- 教学点已参与过该活动（有打卡记录）
- 该教学点尚未对该活动进行评价

**测试步骤**：
1. 准备评价提交请求
   ```json
   {
     "token": "valid_evaluation_qrcode_token",
     "teachingPointId": 1,
     "q1Satisfaction": 3,
     "q2Practicality": 2,
     "q3Quality": 3,
     "suggestionText": "活动内容很实用，希望能多举办"
   }
   ```
2. 调用 POST `/api/evaluations/evaluation`
3. 验证响应

**预期结果**：
- HTTP 状态码：200
- 响应消息：评价提交成功
- 返回数据包含：id、activityId、teachingPointId、submittedTime

**实际结果**：✓ 通过

---

#### TC-1.2: 提交评价 - 二维码无效
**目标**：验证二维码无效时的错误处理
**前置条件**：准备无效的二维码 Token

**测试步骤**：
1. 准备无效 Token 的评价请求
   ```json
   {
     "token": "invalid_token",
     "teachingPointId": 1,
     ...
   }
   ```
2. 调用 POST `/api/evaluations/evaluation`
3. 验证错误响应

**预期结果**：
- HTTP 状态码：400
- 错误码：1501
- 错误信息：二维码无效

---

#### TC-1.3: 提交评价 - 二维码类型错误
**目标**：验证二维码类型检查
**前置条件**：使用打卡二维码（type = 'checkin'）而非评价二维码

**测试步骤**：
1. 获取打卡二维码的 Token
2. 用打卡 Token 提交评价请求
3. 验证错误响应

**预期结果**：
- HTTP 状态码：400
- 错误码：1501
- 错误信息：二维码无效

---

#### TC-1.4: 提交评价 - 活动不存在
**目标**：验证活动存在性检查
**前置条件**：使用不存在的活动 ID

**测试步骤**：
1. 从有效二维码中提取，但修改请求中的 activityId 为不存在的 ID
2. 调用评价提交接口
3. 验证错误响应

**预期结果**：
- HTTP 状态码：400
- 错误码：1301
- 错误信息：活动不存在

---

#### TC-1.5: 提交评价 - 活动未结束
**目标**：验证活动状态检查
**前置条件**：活动状态为 'ongoing' 或 'draft'

**测试步骤**：
1. 创建未结束的活动
2. 生成该活动的评价二维码
3. 尝试提交评价
4. 验证错误响应

**预期结果**：
- HTTP 状态码：400
- 错误码：1304
- 错误信息：活动未结束，暂无法评价

---

#### TC-1.6: 提交评价 - 教学点未参与活动
**目标**：验证参与资格检查
**前置条件**：教学点未参与过该活动（无打卡记录）

**测试步骤**：
1. 选择一个未参与该活动的教学点
2. 尝试提交评价
3. 验证错误响应

**预期结果**：
- HTTP 状态码：400
- 错误码：1601
- 错误信息：教学点未参与过此活动，无法进行评价

---

#### TC-1.7: 提交评价 - 重复评价
**目标**：验证防重复评价机制
**前置条件**：
- 教学点已对该活动进行过评价
- 尝试再次提交评价

**测试步骤**：
1. 获取已评价的教学点和活动
2. 尝试再次提交评价
3. 验证错误响应

**预期结果**：
- HTTP 状态码：400
- 错误码：1602
- 错误信息：该教学点已评价

---

#### TC-1.8: 提交评价 - 参数校验
**目标**：验证参数有效性检查

**测试子用例**：

**TC-1.8.1: 缺少必填字段**
```json
{
  "teachingPointId": 1,
  "q1Satisfaction": 3
  // 缺少 token、q2Practicality
}
```
预期：400，字段验证错误

**TC-1.8.2: 满意度评分超出范围**
```json
{
  ...
  "q1Satisfaction": 5  // 应为 1-3
}
```
预期：400，满意度必须为1-3之间的值

**TC-1.8.3: 建议文本超出长度**
```json
{
  ...
  "suggestionText": "..." // 超过 200 字
}
```
预期：400，建议最多200个字符

---

### 模块 2：评价列表查询接口 (`GET /api/evaluations`)

#### TC-2.1: 查询评价列表 - 市级管理员
**目标**：验证市级管理员可查看全部评价
**前置条件**：
- 已登录为市级管理员（city role）
- 有有效的 JWT Token

**测试步骤**：
1. 使用 Authorization Header 添加市级管理员 Token
   ```
   Authorization: Bearer <city_admin_token>
   ```
2. 调用 GET `/api/evaluations?pageNum=1&pageSize=10`
3. 验证响应

**预期结果**：
- HTTP 状态码：200
- 返回分页数据
- records 包含所有县的评价

---

#### TC-2.2: 查询评价列表 - 县级管理员
**目标**：验证县级管理员仅查看本县数据
**前置条件**：
- 已登录为某县的县级管理员
- 有有效的 JWT Token

**测试步骤**：
1. 使用 Authorization Header 添加县级管理员 Token
2. 调用 GET `/api/evaluations?pageNum=1&pageSize=10`
3. 验证返回的数据仅属于该县

**预期结果**：
- HTTP 状态码：200
- 返回数据仅包含该县的评价

---

#### TC-2.3: 查询评价列表 - 按活动过滤
**目标**：验证按活动 ID 过滤功能
**前置条件**：某个活动已有多条评价

**测试步骤**：
1. 调用 GET `/api/evaluations?activityId=1&pageNum=1&pageSize=10`
2. 验证返回的数据都属于指定活动

**预期结果**：
- HTTP 状态码：200
- 所有记录的 activityId 都等于查询参数中的 activityId

---

#### TC-2.4: 查询评价列表 - 按教学点过滤
**目标**：验证按教学点 ID 过滤功能

**测试步骤**：
1. 调用 GET `/api/evaluations?teachingPointId=1&pageNum=1&pageSize=10`
2. 验证返回的数据都属于指定教学点

**预期结果**：
- HTTP 状态码：200
- 所有记录的 teachingPointId 都等于查询参数中的 teachingPointId

---

#### TC-2.5: 查询评价列表 - 分页功能
**目标**：验证分页查询正确性

**测试步骤**：
1. 调用 GET `/api/evaluations?pageNum=1&pageSize=5`
2. 记录返回的记录数和总数
3. 调用 GET `/api/evaluations?pageNum=2&pageSize=5`
4. 验证两页数据不重复

**预期结果**：
- 第一页返回最多 5 条记录
- 第二页返回不同的记录
- current = 1, size = 5 等字段正确

---

#### TC-2.6: 查询评价列表 - 排序
**目标**：验证按提交时间倒序排列

**测试步骤**：
1. 调用 GET `/api/evaluations?pageNum=1&pageSize=10`
2. 检查返回的记录的 submittedTime 是否倒序排列

**预期结果**：
- submittedTime 从最新到最旧排列

---

#### TC-2.7: 查询评价列表 - 无权限
**目标**：验证权限控制
**前置条件**：未登录或使用无效 Token

**测试步骤**：
1. 不提供 Authorization Header
2. 调用 GET `/api/evaluations`
3. 验证错误响应

**预期结果**：
- HTTP 状态码：401 或 403
- 提示未授权或权限不足

---

### 模块 3：评价统计接口 (`GET /api/evaluations/statistics`)

#### TC-3.1: 查询评价统计 - 正常查询
**目标**：验证评价统计功能
**前置条件**：某个活动已有多条评价

**测试步骤**：
1. 调用 GET `/api/evaluations/statistics?activityId=1`
2. 验证响应数据

**预期结果**：
- HTTP 状态码：200
- 返回数据包含：totalCount, avgSatisfaction, avgPracticality, avgQuality, 等
- avgSatisfaction 在 0-3 之间（或 NULL）
- satisfactionLevel3 + satisfactionLevel2 + satisfactionLevel1 = totalCount

---

#### TC-3.2: 查询评价统计 - 活动不存在
**目标**：验证活动存在性检查
**前置条件**：使用不存在的活动 ID

**测试步骤**：
1. 调用 GET `/api/evaluations/statistics?activityId=9999`
2. 验证错误响应

**预期结果**：
- HTTP 状态码：400
- 错误码：1301
- 错误信息：活动不存在

---

#### TC-3.3: 查询评价统计 - 无评价记录
**目标**：验证无评价时的统计处理
**前置条件**：某个活动尚未有任何评价

**测试步骤**：
1. 调用 GET `/api/evaluations/statistics?activityId=<无评价的活动>`
2. 验证响应

**预期结果**：
- HTTP 状态码：200
- totalCount = 0
- avgSatisfaction = 0.0
- satisfactionLevel3 = 0 等

---

#### TC-3.4: 查询评价统计 - 计算准确性
**目标**：验证统计计算的准确性
**前置条件**：已手动创建测试数据

**测试步骤**：
1. 在数据库中创建 10 条测试评价：
   - 5 条满意度为 3
   - 3 条满意度为 2
   - 2 条满意度为 1
2. 调用统计接口
3. 验证返回的等级数据

**预期结果**：
- totalCount = 10
- satisfactionLevel3 = 5
- satisfactionLevel2 = 3
- satisfactionLevel1 = 2
- avgSatisfaction ≈ 2.3

---

#### TC-3.5: 查询评价统计 - 权限控制
**目标**：验证权限检查
**前置条件**：未登录或权限不足

**测试步骤**：
1. 不提供 Authorization Header
2. 调用 GET `/api/evaluations/statistics?activityId=1`
3. 验证错误响应

**预期结果**：
- HTTP 状态码：401 或 403

---

## 性能测试

### PT-1: 大数据量评价查询
**目标**：验证性能

**测试步骤**：
1. 在某个活动下创建 10000 条评价
2. 调用 GET `/api/evaluations?activityId=X&pageNum=1&pageSize=100`
3. 记录响应时间

**预期结果**：
- 响应时间 < 1000ms

---

### PT-2: 统计查询性能
**目标**：验证统计查询性能

**测试步骤**：
1. 创建 100000 条评价
2. 调用统计接口
3. 记录响应时间

**预期结果**：
- 响应时间 < 1000ms

---

## 并发测试

### CT-1: 并发提交评价
**目标**：验证防重复机制在并发情况下的有效性

**测试步骤**：
1. 使用压力测试工具（如 JMeter）
2. 同时发送 10 个相同的评价提交请求
3. 验证是否只有 1 个成功

**预期结果**：
- 仅 1 个请求成功（HTTP 200）
- 其他 9 个请求返回 1602 错误（已评价）

---

## 集成测试

### IT-1: 完整评价流程
**目标**：验证从打卡到评价的完整流程

**测试步骤**：
1. 创建活动
2. 生成打卡二维码
3. 提交打卡
4. 结束活动
5. 生成评价二维码
6. 提交评价
7. 查询评价列表
8. 查询评价统计

**预期结果**：
- 所有步骤都成功
- 数据一致性正确

---

## 边界值测试

### BT-1: 满意度评分边界值
**目标**：验证边界值处理

**测试用例**：
- q1Satisfaction = 0 → 错误
- q1Satisfaction = 1 → 成功
- q1Satisfaction = 3 → 成功
- q1Satisfaction = 4 → 错误

---

### BT-2: 建议文本长度边界值
**目标**：验证字符串长度限制

**测试用例**：
- 199 字 → 成功
- 200 字 → 成功
- 201 字 → 错误

---

## 测试结果汇总

| 测试用例 | 预期结果 | 实际结果 | 状态 |
|---|---|---|---|
| TC-1.1 | 通过 | 通过 | ✓ |
| TC-1.2 | 错误 1501 | 错误 1501 | ✓ |
| TC-1.3 | 错误 1501 | 错误 1501 | ✓ |
| TC-1.4 | 错误 1301 | 错误 1301 | ✓ |
| TC-1.5 | 错误 1304 | 错误 1304 | ✓ |
| TC-1.6 | 错误 1601 | 错误 1601 | ✓ |
| TC-1.7 | 错误 1602 | 错误 1602 | ✓ |
| TC-1.8.1 | 错误 400 | 错误 400 | ✓ |
| TC-1.8.2 | 错误 400 | 错误 400 | ✓ |
| TC-1.8.3 | 错误 400 | 错误 400 | ✓ |
| TC-2.1 | 成功 | 成功 | ✓ |
| TC-2.2 | 仅本县数据 | 仅本县数据 | ✓ |
| TC-2.3 | 按活动过滤 | 按活动过滤 | ✓ |
| TC-2.4 | 按教学点过滤 | 按教学点过滤 | ✓ |
| TC-2.5 | 分页正确 | 分页正确 | ✓ |
| TC-2.6 | 倒序排列 | 倒序排列 | ✓ |
| TC-2.7 | 权限拒绝 | 权限拒绝 | ✓ |
| TC-3.1 | 统计正确 | 统计正确 | ✓ |
| TC-3.2 | 错误 1301 | 错误 1301 | ✓ |
| TC-3.3 | 0 数据 | 0 数据 | ✓ |
| TC-3.4 | 计算准确 | 计算准确 | ✓ |
| TC-3.5 | 权限拒绝 | 权限拒绝 | ✓ |

---

## 缺陷报告模板

```
缺陷编号：BUG-XXX
标题：[简洁的问题描述]
严重级别：[高/中/低]
优先级：[P0/P1/P2]

描述：
[详细的问题描述]

重现步骤：
1. [步骤1]
2. [步骤2]
...

预期结果：
[应该发生的结果]

实际结果：
[实际发生的结果]

附加信息：
- 操作系统：
- 浏览器/工具：
- 环境：[开发/测试/预发布]
- 截图/日志：
```

---

## 测试完成检查清单

- [ ] 所有单元测试用例执行完毕
- [ ] 所有集成测试用例执行完毕
- [ ] 性能测试满足要求
- [ ] 并发测试通过
- [ ] 边界值测试通过
- [ ] 无严重缺陷
- [ ] API 文档已验证
- [ ] 代码审查完成
- [ ] 文档已更新

---

## 注意事项

1. **测试数据隔离**：使用独立的测试数据库或数据库事务隔离
2. **二维码生成**：需要有相应的二维码生成接口支持测试
3. **时间同步**：确保服务器时间准确（影响二维码过期判断）
4. **日志收集**：记录每个测试的详细日志便于问题诊断
5. **自动化测试**：建议后期使用 JUnit + Mockito 进行自动化测试

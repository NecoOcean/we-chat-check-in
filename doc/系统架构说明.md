# 系统架构说明（版本 5 对齐）

## 一、总体架构

- 前端：微信小程序，包含管理端（市级/县级）与参与端（教学点）。
- 后端：Java + SpringBoot 多模块架构，提供认证、活动、二维码、参与、评价、看板、审计等模块。
- 数据层：关系型数据库（MySQL），二维码图片以Base64编码直接存储在数据库中。
- 运维：容器化部署（Docker）、反向代理（Nginx）、监控与日志（如Prometheus + Logback）。

## 二、SpringBoot 模块划分

### 核心模块结构
```
we-chat-check-in/
├── we-chat-common/          # 公共模块（工具类、常量、异常定义）
├── we-chat-auth/            # 认证授权模块
├── we-chat-activity/        # 活动管理模块
├── we-chat-qrcode/          # 二维码管理模块
├── we-chat-checkins/        # 参与打卡模块
├── we-chat-evaluation/      # 活动评价模块
├── we-chat-dashboard/       # 数据看板模块
├── we-chat-admin/           # 用户管理模块
├── we-chat-audit/           # 审计日志模块
└── we-chat-web/             # Web启动模块（Controller层）
```

### 模块职责
- **we-chat-common**：通用工具类、响应封装、异常处理、常量定义。
- **we-chat-auth**：JWT令牌管理、登录鉴权、角色权限（市/县）校验。
- **we-chat-activity**：活动CRUD、状态管理、与二维码服务联动。
- **we-chat-qrcode**：打卡与评价二维码生成、状态管理、签名校验。
- **we-chat-checkins**：打卡提交、幂等处理、数据校验。
- **we-chat-evaluation**：评价提交、参与资格校验、统计汇总。
- **we-chat-dashboard**：平台总览、活动统计、数据聚合。
- **we-chat-admin**：县级账号管理（仅市级权限）。
- **we-chat-audit**：关键操作审计、日志记录。
- **we-chat-web**：统一Controller、全局异常处理、接口文档。

## 三、关键流程

1) **打卡流程**：
二维码扫描 → 前端携带`token`与表单数据 → 后端校验签名/有效期/状态 → 校验活动进行中 → 幂等写入出勤数据 → 返回成功 → 看板/详情实时更新。

2) **评价流程**：
活动结束 → 生成评价二维码 → 扫码进入评价页 → 后端校验教学点是否参与过活动 → 写入评价数据 → 汇总与明细可查。

3) **活动结束**：
管理员点击结束 → 更新活动状态 → 关联打卡二维码状态置失效 → 审计日志记录。

## 四、技术栈与依赖

### 后端技术栈
- **JDK版本**：JDK 17
- **框架**：Spring Boot 3.5.7、Spring Security 6.x、Spring Web 6.x
- **持久层**：MyBatis Plus 3.5.14（替代Spring Data JPA）
- **数据库**：MySQL 8.0+、MySQL Connector 8.0.33、HikariCP 5.x连接池
- **工具库**：Hutool 5.8.22（工具类）、MapStruct 1.5.5.Final（对象映射）、Validation 3.x（参数校验）
- **安全认证**：JWT 4.4.0（io.jsonwebtoken:jjwt-api）
- **二维码**：ZXing 3.5.2（二维码生成与解析）
- **文档**：Springdoc OpenAPI 2.2.0、Knife4j 4.3.0（API文档，适配Spring Boot 3.x）
- **日志**：Logback 1.4.x + SLF4J 2.x
- **构建**：Maven 3.8+ 多模块管理、Maven Compiler Plugin 3.11.0

### 数据存储策略
- **关系数据**：MySQL存储用户、活动、打卡、评价等核心业务数据
- **二维码图片**：Base64编码直接存储在数据库LONGTEXT字段中
- **统计数据**：通过数据库聚合查询实现，无需额外缓存层

## 五、权限与安全

- **角色隔离**：市级访问全量；县级仅本县；参与端仅提交权限。
- **二维码安全**：签名 + 授权校验；支持禁用与过期；防伪与防篡改。
- **接口安全**：Spring Security + JWT；统一异常处理；敏感操作审计。
- **数据安全**：密码BCrypt加密；SQL注入防护；参数校验。

## 六、部署与运维

### 环境配置
- **多环境**：application-dev/test/prod.yml配置文件分离
- **配置管理**：Spring Boot ConfigurationProperties + 环境变量
- **数据库连接**：HikariCP连接池 + 多数据源配置

### 监控与日志
- **应用监控**：Spring Boot Actuator + Prometheus指标采集
- **日志管理**：Logback按日期滚动 + 错误级别分离
- **性能监控**：接口响应时间、数据库连接池状态、JVM内存

### 备份策略
- **数据库备份**：MySQL定期全量备份 + binlog增量备份
- **审计日志**：按月归档，保留2年
- **应用部署**：Docker容器化 + Nginx反向代理
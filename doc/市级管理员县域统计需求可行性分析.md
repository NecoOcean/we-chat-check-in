# 市级管理员县域统计需求可行性分析

**分析日期：** 2024-10-31  
**需求状态：** ✅ **可以实现**  
**实现难度：** 中等  
**预计工作量：** 3-5 天

---

## 需求描述

市级管理员发起活动时，能够：
1. ✅ 统计各县份的打卡情况
2. ✅ 查看各县中参与打卡的教学点数量分布
3. ✅ 查看整个县报备的人数总和
4. ✅ 活动详情中展示所有已参与打卡的教学点信息（教学点名称、参与人数、打卡时间）
5. ✅ 可以根据县域进行划分查看

---

## 可行性分析

### 1️⃣ 现有数据结构分析

#### 活动表（activities）
```java
// Activity.java 关键字段
@TableField("scope_county_code")
private String scopeCountyCode;  // ✅ 包含县域编码
```

**结论：** ✅ 活动已包含 `scopeCountyCode` 字段，支持县域范围设置

#### 打卡表（checkins）
```java
// Checkin.java 关键字段
@TableField("activity_id")
private Long activityId;           // ✅ 活动ID

@TableField("teaching_point_id")
private Long teachingPointId;      // ✅ 教学点ID

@TableField("attendee_count")
private Integer attendeeCount;     // ✅ 参与人数
```

**问题：** ❌ Checkin 表中**没有直接存储县域信息**

**解决方案：** 需要通过教学点表 (`teaching_points`) 关联县域信息

#### 教学点表（teaching_points）- 假设结构
```sql
-- 假设表结构（需要确认）
CREATE TABLE teaching_points (
    id BIGINT PRIMARY KEY,
    name VARCHAR(255),
    county_code VARCHAR(50),  -- ✅ 县域编码
    ...
);
```

**结论：** 需要确认教学点表是否存在且包含县域编码

### 2️⃣ 权限隔离分析

#### 当前权限设计
- ✅ 市级管理员（CITY）：可查看全市所有活动
- ✅ 县级管理员（COUNTY）：仅查看本县活动
- ✅ Activity 表已支持权限隔离

**结论：** ✅ 权限框架已完善，市级管理员可访问所有数据

---

## 实现方案

### 📋 方案1：添加新的统计接口（推荐）

#### 新增API

```java
// ActivityService.java - 添加新方法
public interface ActivityService {
    
    /**
     * 按县域统计活动打卡情况
     * 
     * @param activityId 活动ID
     * @return 县域打卡统计列表
     */
    List<CountyCheckinStatisticsVO> getCountyCheckinStatistics(Long activityId);
    
    /**
     * 获取活动的所有打卡详情（按县域分组）
     * 
     * @param activityId 活动ID
     * @param countyCode 县域编码（可选）
     * @return 打卡详情列表
     */
    Page<CheckinDetailVO> getCheckinDetailsByCounty(Long activityId, String countyCode, 
                                                     int page, int size);
}
```

#### 新增VO对象

```java
// CountyCheckinStatisticsVO.java - 县域打卡统计
@Data
@Builder
public class CountyCheckinStatisticsVO {
    private String countyCode;              // 县域编码
    private String countyName;              // 县域名称
    private Integer participatingPoints;    // 参与打卡的教学点数
    private Integer totalAttendees;         // 累计参与人数
    private Integer totalCheckins;          // 打卡记录总数
}

// CheckinDetailVO.java - 打卡详情
@Data
@Builder
public class CheckinDetailVO {
    private Long id;                        // 打卡ID
    private Long teachingPointId;           // 教学点ID
    private String teachingPointName;       // 教学点名称
    private String countyCode;              // 县域编码
    private String countyName;              // 县域名称
    private Integer attendeeCount;          // 参与人数
    private LocalDateTime submittedTime;    // 打卡时间
}
```

#### 核心SQL查询

```sql
-- 按县域统计打卡情况
SELECT 
    tp.county_code AS countyCode,
    COUNT(DISTINCT c.teaching_point_id) AS participatingPoints,
    COALESCE(SUM(c.attendee_count), 0) AS totalAttendees,
    COUNT(*) AS totalCheckins
FROM checkins c
LEFT JOIN teaching_points tp ON c.teaching_point_id = tp.id
WHERE c.activity_id = #{activityId}
GROUP BY tp.county_code
ORDER BY tp.county_code;

-- 获取打卡详情（可按县域过滤）
SELECT 
    c.id,
    c.teaching_point_id,
    tp.name AS teachingPointName,
    tp.county_code,
    c.attendee_count,
    c.submitted_time
FROM checkins c
LEFT JOIN teaching_points tp ON c.teaching_point_id = tp.id
WHERE c.activity_id = #{activityId}
    AND (#{countyCode} IS NULL OR tp.county_code = #{countyCode})
ORDER BY c.submitted_time DESC
LIMIT #{offset}, #{size};
```

#### 修改现有活动详情

```java
// ActivityDetailVO.java - 扩展
@Data
@Builder
public class ActivityDetailVO {
    // ... 现有字段 ...
    
    // 新增字段
    private List<CountyCheckinStatisticsVO> countyStatistics;  // 县域统计列表
    private List<CheckinDetailVO> checkinDetails;              // 打卡详情列表
}
```

---

### 📋 方案2：扩展现有查询方法

#### 修改现有的 getActivityDetail 方法

```java
@Override
public ActivityDetailVO getActivityDetail(Long activityId, String adminRole, String countyCode) {
    // ... 现有代码 ...
    
    // 如果是市级管理员，返回县域统计
    List<CountyCheckinStatisticsVO> countyStatistics = null;
    if ("city".equals(adminRole)) {
        countyStatistics = getCountyCheckinStatistics(activityId);
    }
    
    // 返回详情时包含县域统计
    return ActivityDetailVO.builder()
            .activity(convertToVO(activity))
            .participatedCount(participatedCount)
            .totalAttendees(totalAttendees)
            .evaluationCount(evaluationCount)
            .countyStatistics(countyStatistics)  // 新增
            .qrCodes(qrCodes)
            .build();
}
```

---

## 实现步骤

### Step 1️⃣：确认教学点表结构

```java
// 验证教学点表是否存在且包含县域信息
// 需要查看数据库设计文档或教学点实体定义
```

**检查项：**
- ✅ 教学点表名称和字段
- ✅ 县域字段名称（如 `county_code` 或 `district_code`）
- ✅ 是否有对应的 Java 实体类

### Step 2️⃣：创建 VO 对象

- 创建 `CountyCheckinStatisticsVO.java`（县域统计VO）
- 创建 `CheckinDetailVO.java`（打卡详情VO）
- 修改 `ActivityDetailVO.java`

### Step 3️⃣：扩展 Mapper 和 SQL

```java
// ActivityMapper.java - 添加新的查询方法
@Select("SELECT tp.county_code, COUNT(DISTINCT c.teaching_point_id) as points, " +
        "COALESCE(SUM(c.attendee_count), 0) as attendees " +
        "FROM checkins c " +
        "LEFT JOIN teaching_points tp ON c.teaching_point_id = tp.id " +
        "WHERE c.activity_id = #{activityId} " +
        "GROUP BY tp.county_code")
List<CountyStatisticEntity> selectCountyStatistics(@Param("activityId") Long activityId);
```

### Step 4️⃣：实现 Service 方法

在 `ActivityServiceImpl.java` 中实现：
- `getCountyCheckinStatistics(Long activityId)`
- 扩展的 `getActivityDetail()` 方法

### Step 5️⃣：更新 Controller

在 `ActivityController.java` 中的 `getActivityDetail` 接口会自动返回新字段

### Step 6️⃣：测试

- 单元测试：新增统计方法
- 集成测试：完整的活动详情查询
- 权限测试：确认市级/县级管理员的行为差异

---

## 数据流示例

```
市级管理员查询活动详情
    ↓
GET /api/activities/{activityId}/detail
    ↓
ActivityController.getActivityDetail()
    ↓
ActivityService.getActivityDetail()
    ├─ 查询活动基本信息
    ├─ 查询总的统计数据
    ├─ 查询县域分布统计 ← NEW
    ├─ 查询打卡详情列表 ← NEW
    └─ 查询二维码信息
    ↓
返回增强的 ActivityDetailVO
    ├─ activity: 活动基本信息
    ├─ participatedCount: 总参与点数
    ├─ totalAttendees: 总参与人数
    ├─ evaluationCount: 评价数
    ├─ countyStatistics: [        ← NEW
    │   {
    │     countyCode: "001",
    │     countyName: "朝阳区",
    │     participatingPoints: 15,
    │     totalAttendees: 150
    │   },
    │   ...
    │ ]
    ├─ checkinDetails: [          ← NEW
    │   {
    │     id: 1,
    │     teachingPointName: "第一小学",
    │     countyName: "朝阳区",
    │     attendeeCount: 30,
    │     submittedTime: "2024-03-15T14:30:00"
    │   },
    │   ...
    │ ]
    └─ qrCodes: 二维码列表
```

---

## 前端展示示例

### 县域统计表格
```
┌─────────┬──────────┬────────────┬──────────────┐
│ 县域    │ 教学点数 │ 累计人数   │ 打卡记录数   │
├─────────┼──────────┼────────────┼──────────────┤
│ 朝阳区  │ 15       │ 150        │ 15           │
│ 丰台区  │ 12       │ 120        │ 12           │
│ 东城区  │ 10       │ 95         │ 10           │
│ 合计    │ 37       │ 365        │ 37           │
└─────────┴──────────┴────────────┴──────────────┘
```

### 打卡详情表格（按县域分组）
```
朝阳区 (15个教学点，150人)
┌──────────────┬──────────┬──────────────────────┐
│ 教学点名称   │ 参与人数 │ 打卡时间             │
├──────────────┼──────────┼──────────────────────┤
│ 第一小学     │ 30       │ 2024-03-15 14:30:00  │
│ 第二小学     │ 25       │ 2024-03-15 15:00:00  │
│ ...          │ ...      │ ...                  │
└──────────────┴──────────┴──────────────────────┘

丰台区 (12个教学点，120人)
┌──────────────┬──────────┬──────────────────────┐
│ 第三小学     │ 28       │ 2024-03-15 14:45:00  │
│ ...          │ ...      │ ...                  │
└──────────────┴──────────┴──────────────────────┘
```

---

## 前置条件与注意事项

### ⚠️ 关键前置条件

1. **教学点表确认**
   - ❓ 系统是否存在 `teaching_points` 表
   - ❓ 表中是否包含 `county_code` 或类似的县域字段
   - ❓ 是否有对应的 Java 实体类

2. **教学点ID有效性**
   - ❓ 所有打卡记录中的 `teaching_point_id` 是否都对应有效的教学点
   - ❓ 是否存在孤立的打卡记录（无对应教学点）

3. **数据完整性**
   - ✅ 活动表的 `scope_county_code` 是否有效
   - ✅ 打卡表的数据是否完整

### ⚠️ 实现注意事项

1. **性能考虑**
   - 大数据量活动时，LEFT JOIN 可能影响性能
   - 建议添加必要的索引：
    ```sql
    CREATE INDEX idx_checkins_teaching_point ON checkins(teaching_point_id);
    CREATE INDEX idx_teaching_points_county ON teaching_points(county_code);
    ```

2. **空值处理**
   - 某些教学点可能没有县域信息，需要处理 NULL 值
   - 建议将其作为"未分类"单独统计

3. **权限检查**
   - 市级管理员可查看全部
   - 县级管理员仅查看本县（已通过 ActivityServiceImpl.validateActivityPermission 保证）

4. **数据量限制**
   - 打卡详情列表需要分页处理
   - 避免一次性返回大量数据

---

## 实现工作分解

| 任务 | 工作量 | 难度 |
|------|--------|------|
| 1. 确认教学点表结构 | 0.5 天 | 低 |
| 2. 创建 VO 对象 | 0.5 天 | 低 |
| 3. 扩展 Mapper 和 SQL | 1 天 | 中 |
| 4. 实现 Service 方法 | 1 天 | 中 |
| 5. 单元测试 | 0.5 天 | 中 |
| 6. 集成测试 | 0.5 天 | 中 |
| **总计** | **3-4 天** | **中** |

---

## 依赖关系

```
需求实现依赖：
└─ 教学点表确认 ✓ (需要确认)
   ├─ 创建 VO 对象
   ├─ 创建 Mapper 查询
   └─ 实现 Service 逻辑
       └─ 更新 ActivityDetailVO
           └─ 前端展示
```

---

## 总体结论

### ✅ **需求完全可以实现**

**实现可行性：** 🟢 高  
**技术复杂度：** 🟡 中  
**预计工作量：** 3-4 天  
**风险等级：** 🟢 低  

### 关键要点

1. ✅ 系统架构支持县域隔离设计
2. ✅ 现有权限框架完善
3. ❓ **需要确认教学点表结构**（这是唯一的前置条件）
4. ✅ 实现方案清晰，工作量可控

### 建议下一步

1. **优先级1：** 确认教学点表 (`teaching_points`) 的存在和结构
2. **优先级2：** 检查是否存在教学点实体类和 Mapper
3. **优先级3：** 根据实际结构调整 SQL 查询语句
4. **优先级4：** 启动实现工作

---

**附注：** 本分析假设系统存在教学点表并且与打卡记录通过 ID 关联。如教学点表不存在，需要先创建该表。


# 后端开发任务清单补充

## Web配置和异常处理

### Web配置类 (`config/WebConfig.java`)
- [ ] **Web配置类**
```java
@Configuration
@EnableWebMvc
public class WebConfig implements WebMvcConfigurer {
    
    @Autowired
    private AuthInterceptor authInterceptor;
    
    /**
     * 配置拦截器
     */
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(authInterceptor)
            .addPathPatterns("/api/**")
            .excludePathPatterns(
                "/api/auth/qr-login",
                "/api/auth/verify-token",
                "/error",
                "/favicon.ico"
            );
    }
    
    /**
     * 配置CORS跨域
     */
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
            .allowedOriginPatterns("*")
            .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
            .allowedHeaders("*")
            .allowCredentials(true)
            .maxAge(3600);
    }
    
    /**
     * 配置消息转换器
     */
    @Override
    public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {
        // 配置Jackson消息转换器
        MappingJackson2HttpMessageConverter converter = new MappingJackson2HttpMessageConverter();
        ObjectMapper objectMapper = new ObjectMapper();
        
        // 配置日期格式
        objectMapper.setDateFormat(new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        
        converter.setObjectMapper(objectMapper);
        converters.add(0, converter);
    }
}
```

### 全局异常处理器 (`exception/GlobalExceptionHandler.java`)
- [ ] **全局异常处理器**
```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    /**
     * 处理参数验证异常
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidationException(MethodArgumentNotValidException e) {
        List<String> errors = e.getBindingResult()
            .getFieldErrors()
            .stream()
            .map(error -> error.getField() + ": " + error.getDefaultMessage())
            .collect(Collectors.toList());
        
        ErrorResponse response = ErrorResponse.builder()
            .code("VALIDATION_ERROR")
            .message("参数验证失败")
            .details(errors)
            .timestamp(LocalDateTime.now())
            .build();
        
        return ResponseEntity.badRequest().body(response);
    }
    
    /**
     * 处理业务异常
     */
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ErrorResponse> handleBusinessException(BusinessException e) {
        ErrorResponse response = ErrorResponse.builder()
            .code(e.getCode())
            .message(e.getMessage())
            .timestamp(LocalDateTime.now())
            .build();
        
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }
    
    /**
     * 处理认证异常
     */
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity<ErrorResponse> handleAuthenticationException(AuthenticationException e) {
        ErrorResponse response = ErrorResponse.builder()
            .code("AUTHENTICATION_ERROR")
            .message("认证失败: " + e.getMessage())
            .timestamp(LocalDateTime.now())
            .build();
        
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(response);
    }
    
    /**
     * 处理权限异常
     */
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ErrorResponse> handleAccessDeniedException(AccessDeniedException e) {
        ErrorResponse response = ErrorResponse.builder()
            .code("ACCESS_DENIED")
            .message("权限不足")
            .timestamp(LocalDateTime.now())
            .build();
        
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(response);
    }
    
    /**
     * 处理系统异常
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleException(Exception e) {
        log.error("系统异常", e);
        
        ErrorResponse response = ErrorResponse.builder()
            .code("SYSTEM_ERROR")
            .message("系统内部错误")
            .timestamp(LocalDateTime.now())
            .build();
        
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
    }
}
```

## DTO和VO类设计

### 请求DTO类
- [ ] **二维码登录请求** (`dto/request/QRLoginRequest.java`)
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class QRLoginRequest {
    
    @NotBlank(message = "二维码内容不能为空")
    private String qrContent;
    
    @Size(max = 50, message = "设备信息长度不能超过50个字符")
    private String deviceInfo;
    
    @Size(max = 15, message = "IP地址长度不能超过15个字符")
    private String ipAddress;
}
```

- [ ] **活动创建请求** (`dto/request/ActivityCreateDTO.java`)
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ActivityCreateDTO {
    
    @NotBlank(message = "活动名称不能为空")
    @Size(max = 100, message = "活动名称长度不能超过100个字符")
    private String activityName;
    
    @Size(max = 500, message = "活动描述长度不能超过500个字符")
    private String description;
    
    @NotNull(message = "开始时间不能为空")
    @Future(message = "开始时间必须是未来时间")
    private LocalDateTime startTime;
    
    @NotNull(message = "结束时间不能为空")
    @Future(message = "结束时间必须是未来时间")
    private LocalDateTime endTime;
    
    @NotBlank(message = "参与范围不能为空")
    private String targetScope;
    
    @Size(max = 200, message = "备注长度不能超过200个字符")
    private String remarks;
    
    @AssertTrue(message = "结束时间必须晚于开始时间")
    public boolean isEndTimeAfterStartTime() {
        return endTime == null || startTime == null || endTime.isAfter(startTime);
    }
}
```

- [ ] **签到提交请求** (`dto/request/CheckinSubmitDTO.java`)
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class CheckinSubmitDTO {
    
    @NotNull(message = "活动ID不能为空")
    private Long activityId;
    
    @NotNull(message = "参与人数不能为空")
    @Min(value = 1, message = "参与人数至少为1人")
    @Max(value = 1000, message = "参与人数不能超过1000人")
    private Integer attendanceCount;
    
    @Size(max = 200, message = "备注长度不能超过200个字符")
    private String remarks;
    
    @Valid
    private List<@Valid ParticipantInfo> participants;
    
    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class ParticipantInfo {
        
        @NotBlank(message = "参与者姓名不能为空")
        @Size(max = 50, message = "参与者姓名长度不能超过50个字符")
        private String name;
        
        @Size(max = 20, message = "联系电话长度不能超过20个字符")
        private String phone;
        
        @Size(max = 50, message = "职务长度不能超过50个字符")
        private String position;
    }
}
```

- [ ] **评价提交请求** (`dto/request/EvaluationSubmitDTO.java`)
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EvaluationSubmitDTO {
    
    @NotNull(message = "活动ID不能为空")
    private Long activityId;
    
    @NotNull(message = "满意度评分不能为空")
    @Min(value = 1, message = "满意度评分最低为1分")
    @Max(value = 5, message = "满意度评分最高为5分")
    private Integer satisfactionScore;
    
    @NotNull(message = "实用性评分不能为空")
    @Min(value = 1, message = "实用性评分最低为1分")
    @Max(value = 5, message = "实用性评分最高为5分")
    private Integer usefulnessScore;
    
    @Size(max = 500, message = "评价内容长度不能超过500个字符")
    private String content;
    
    @Size(max = 200, message = "建议长度不能超过200个字符")
    private String suggestions;
}
```

### 响应VO类
- [ ] **认证响应** (`dto/response/AuthResponse.java`)
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class AuthResponse {
    
    private boolean success;
    private String token;
    private RoleType roleType;
    private String roleCode;
    private String roleName;
    private Integer expiresIn;
    private String message;
    private LocalDateTime timestamp;
    
    public static AuthResponse success(String token, RoleType roleType, String roleCode, String roleName) {
        return AuthResponse.builder()
            .success(true)
            .token(token)
            .roleType(roleType)
            .roleCode(roleCode)
            .roleName(roleName)
            .expiresIn(3600)
            .timestamp(LocalDateTime.now())
            .build();
    }
    
    public static AuthResponse error(String message) {
        return AuthResponse.builder()
            .success(false)
            .message(message)
            .timestamp(LocalDateTime.now())
            .build();
    }
}
```

- [ ] **活动详情响应** (`dto/response/ActivityDetailVO.java`)
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ActivityDetailVO {
    
    private Long id;
    private String activityCode;
    private String activityName;
    private String description;
    private LocalDateTime startTime;
    private LocalDateTime endTime;
    private ActivityStatus status;
    private String targetScope;
    private String creatorCode;
    private String creatorName;
    private CreatorType creatorType;
    private String remarks;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    // 统计信息
    private Long totalSchools;
    private Long totalParticipants;
    private Long evaluationCount;
    private Double averageSatisfactionScore;
    private Double averageUsefulnessScore;
}
```

- [ ] **签到结果响应** (`dto/response/CheckinResult.java`)
```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class CheckinResult {
    
    private boolean success;
    private String message;
    private Long checkinId;
    private LocalDateTime submitTime;
    private String errorCode;
    
    public static CheckinResult success(Long checkinId, LocalDateTime submitTime) {
        return CheckinResult.builder()
            .success(true)
            .message("签到成功")
            .checkinId(checkinId)
            .submitTime(submitTime)
            .build();
    }
    
    public static CheckinResult error(String errorCode, String message) {
        return CheckinResult.builder()
            .success(false)
            .errorCode(errorCode)
            .message(message)
            .build();
    }
}
```

## 配置文件和部署

### 应用配置文件
- [ ] **主配置文件** (`application.yml`)
```yaml
server:
  port: 8080
  servlet:
    context-path: /wechat-checkin

spring:
  application:
    name: wechat-checkin-system
  
  profiles:
    active: dev
  
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/wechat_checkin?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:123456}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
  
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true
  
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: Asia/Shanghai
    default-property-inclusion: non_null

# JWT配置
jwt:
  secret: ${JWT_SECRET:wechat-checkin-system-secret-key-2024}
  expiration: 3600

# 二维码配置
qrcode:
  encryption:
    algorithm: AES
    key: ${QR_ENCRYPTION_KEY:wechat-checkin-qr-key}
  image:
    width: 300
    height: 300
    format: PNG

# 日志配置
logging:
  level:
    com.wechat.checkin: INFO
    org.springframework.web: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/wechat-checkin.log
    max-size: 100MB
    max-history: 30

# 管理端点配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when_authorized
```

### 开发环境配置
- [ ] **开发环境配置** (`application-dev.yml`)
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/wechat_checkin_dev?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
  
  jpa:
    show-sql: true
    hibernate:
      ddl-auto: update

logging:
  level:
    com.wechat.checkin: DEBUG
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
```

### 生产环境配置
- [ ] **生产环境配置** (`application-prod.yml`)
```yaml
spring:
  datasource:
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:wechat_checkin}?useUnicode=true&characterEncoding=utf8&useSSL=true&serverTimezone=Asia/Shanghai
    hikari:
      maximum-pool-size: 50
      minimum-idle: 10
  
  jpa:
    show-sql: false
    hibernate:
      ddl-auto: validate

logging:
  level:
    com.wechat.checkin: INFO
    org.springframework.web: WARN
  file:
    name: /var/log/wechat-checkin/application.log
```

### Docker部署配置
- [ ] **Dockerfile**
```dockerfile
FROM openjdk:11-jre-slim

LABEL maintainer="wechat-checkin-team"

WORKDIR /app

COPY target/wechat-checkin-web-*.jar app.jar

EXPOSE 8080

ENV JAVA_OPTS="-Xms512m -Xmx1024m -Dspring.profiles.active=prod"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

- [ ] **docker-compose.yml**
```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: wechat-checkin-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: wechat_checkin
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d
    networks:
      - wechat-checkin-network

  app:
    build: .
    container_name: wechat-checkin-app
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: wechat_checkin
      DB_USERNAME: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      QR_ENCRYPTION_KEY: ${QR_ENCRYPTION_KEY}
    ports:
      - "8080:8080"
    depends_on:
      - mysql
    networks:
      - wechat-checkin-network
    restart: unless-stopped

volumes:
  mysql_data:

networks:
  wechat-checkin-network:
    driver: bridge
```

## 开发优先级建议

### 高优先级 (核心功能)
1. **实体类和数据库设计** - 系统基础
2. **二维码认证服务** - 核心认证机制
3. **活动管理服务** - 主要业务功能
4. **签到管理服务** - 核心业务流程
5. **基础Web接口** - 前端交互支持

### 中优先级 (重要功能)
1. **权限控制和安全** - 系统安全保障
2. **数据统计功能** - 管理决策支持
3. **异常处理机制** - 系统稳定性

### 低优先级 (可选功能)
1. **报表导出功能** - 可根据实际需求决定是否开发
2. **高级统计分析** - 后期优化功能
3. **性能优化** - 系统成熟后考虑

---

## 技术栈总结

- **框架**: Spring Boot 2.7+, Spring Data JPA
- **数据库**: MySQL 8.0+
- **安全**: JWT Token认证
- **二维码**: ZXing库
- **加密**: AES加密算法
- **报表**: Apache POI (可选)
- **构建工具**: Maven
- **部署**: Docker + Docker Compose

此任务清单涵盖了基于二维码无登录设计的签到打卡系统的完整后端开发任务，可根据实际项目需求和时间安排调整开发优先级。
# 测试数据使用指南

**文档版本：** v1.0  
**创建日期：** 2024-10-31  
**功能：** 县域打卡统计功能测试  
**脚本位置：** `sql/test_county_statistics_data.sql`  

---

## 📋 概述

本文档指导如何使用测试数据脚本测试 **市级管理员县域打卡统计接口** (`GET /api/activities/{id}/county-statistics`)。

测试数据脚本包含完整的测试场景，涵盖多个县域、多个教学点、以及权限隔离验证。

---

## 🎯 测试覆盖范围

### 数据规模

| 项目 | 数量 | 说明 |
|------|------|------|
| 县域 | 3个 | 朝阳区、丰台区、东城区 |
| 教学点 | 15个 | 每个县5个 |
| 活动 | 1个 | 状态为 `ongoing` |
| 打卡记录 | 15条 | 每个教学点1条 |
| 评价记录 | 15条 | 每个教学点1条 |
| 二维码 | 2个 | 打卡二维码 + 评价二维码 |
| 市级管理员 | 系统已有 | 使用系统自动生成的账户（无需插入） |
| 县级管理员 | 3个 | 朝阳区、丰台区、东城区各1个 |

### 测试场景

1. **市级管理员查询** - 应获取全部3个县域的统计数据和全部打卡详情
2. **县级管理员查询** - 应仅获取本县的打卡详情，县域统计返回null
3. **权限隔离验证** - 验证权限隔离逻辑是否正确实现
4. **数据完整性** - 验证返回数据包含所有必要字段

---

## 🚀 快速开始

### 步骤1️⃣: 获取脚本文件

脚本文件位置：
```
sql/test_county_statistics_data.sql
```

### 步骤2️⃣: 导入测试数据

**方法A：使用MySQL客户端**
```bash
mysql -u root -p wechat_checkin < sql/test_county_statistics_data.sql
```

**方法B：在MySQL中执行**
```sql
-- 连接到数据库
USE wechat_checkin;

-- 执行脚本
SOURCE /path/to/sql/test_county_statistics_data.sql;
```

**方法C：使用Navicat或其他工具**
1. 打开 `sql/test_county_statistics_data.sql` 文件
2. 选择数据库 `wechat_checkin`
3. 执行查询

### 步骤3️⃣: 验证数据

脚本执行完成后，应该看到以下验证输出：

```
========== 活动信息 ==========
(活动ID和详细信息)

========== 县域打卡统计 ==========
(3行县域统计数据)

========== 打卡详情列表 ==========
(15行打卡详情)

========== 评价统计 ==========
(3行评价统计)

========== 管理员账号（用于测试） ==========
(4个管理员账号)
```

---

## 🔐 测试账号

所有账号的密码都是 `admin123`

### 市级管理员
```
说明: 系统已自动生成，无需手动创建
使用方法: 使用系统中现有的市级管理员账户登录
示例: 
  - 用户名: admin (或系统实际设置的市级管理员账户)
  - 角色: city
  - 县域: NULL (覆盖全市)
```

### 县级管理员 - 朝阳区
```
用户名: chaoyang_admin
密码: admin123
角色: 县级管理员
县域: 朝阳区 (001)
```

### 县级管理员 - 丰台区
```
用户名: fengtai_admin
密码: admin123
角色: 县级管理员
县域: 丰台区 (002)
```

### 县级管理员 - 东城区
```
用户名: dongcheng_admin
密码: admin123
角色: 县级管理员
县域: 东城区 (003)
```

---

## 🧪 测试用例

### 测试用例1️⃣: 市级管理员查询全部县域统计

**前置条件：**
- 应用已启动
- 测试数据已导入
- 已获得市级管理员的JWT token

**测试步骤：**

1. 获取活动ID（从测试数据中查询）
```bash
# 查询活动ID
SELECT id FROM activities WHERE name = '2024年秋季教学活动';
```

2. 使用市级管理员登录
```bash
curl -X POST "http://localhost:8080/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",  # 请替换为系统实际的市级管理员账户
    "password": "admin123"
  }'

# 记录返回的 token
```

3. 调用县域统计接口（用活动ID替换1）
```bash
curl -X GET "http://localhost:8080/api/activities/1/county-statistics" \
  -H "Authorization: Bearer {市级管理员_token}" \
  -H "Content-Type: application/json"
```

**预期结果：**

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "activity": {
      "id": 1,
      "name": "2024年秋季教学活动",
      "status": "ONGOING",
      ...
    },
    "participatedCount": 15,
    "totalAttendees": 420,  // (30+28+32+26+34+25+29+31+27+33+24+22+28+26+30)
    "evaluationCount": 15,
    "qrCodes": [
      { "id": 1, "type": "checkin", ... },
      { "id": 2, "type": "evaluation", ... }
    ],
    "countyStatistics": [
      {
        "countyCode": "001",
        "countyName": "朝阳区",
        "participatingPoints": 5,
        "totalAttendees": 150,  // (30+28+32+26+34)
        "totalCheckins": 5
      },
      {
        "countyCode": "002",
        "countyName": "丰台区",
        "participatingPoints": 5,
        "totalAttendees": 145,  // (25+29+31+27+33)
        "totalCheckins": 5
      },
      {
        "countyCode": "003",
        "countyName": "东城区",
        "participatingPoints": 5,
        "totalAttendees": 125,  // (24+22+28+26+30)
        "totalCheckins": 5
      }
    ],
    "checkinDetails": [
      {
        "id": 1,
        "teachingPointId": 1,
        "teachingPointName": "朝阳区第一小学",
        "countyCode": "001",
        "countyName": "朝阳区",
        "attendeeCount": 30,
        "submittedTime": "2024-10-30T14:30:00"
      },
      // ... 共15条记录
    ]
  },
  "timestamp": 1698765432000
}
```

**验证要点：**
- ✅ `countyStatistics` 不为null，包含3个县域统计
- ✅ 每个县域的统计数据正确
- ✅ `checkinDetails` 包含全部15条打卡详情
- ✅ 返回数据包含所有必要字段

---

### 测试用例2️⃣: 县级管理员只能查看本县数据

**前置条件：**
- 应用已启动
- 测试数据已导入
- 已获得县级管理员的JWT token

**测试步骤：**

1. 使用朝阳区管理员登录
```bash
curl -X POST "http://localhost:8080/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "chaoyang_admin",
    "password": "admin123"
  }'

# 记录返回的 token
```

2. 调用同一个接口
```bash
curl -X GET "http://localhost:8080/api/activities/1/county-statistics" \
  -H "Authorization: Bearer {县级管理员_token}" \
  -H "Content-Type: application/json"
```

**预期结果：**

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "activity": { ... },
    "participatedCount": 15,
    "totalAttendees": 420,
    "evaluationCount": 15,
    "qrCodes": [...],
    "countyStatistics": null,  // ← 县级管理员看不到这个字段
    "checkinDetails": [
      {
        "id": 1,
        "teachingPointId": 1,
        "teachingPointName": "朝阳区第一小学",
        "countyCode": "001",
        "countyName": "朝阳区",
        "attendeeCount": 30,
        "submittedTime": "2024-10-30T14:30:00"
      },
      // ... 仅5条朝阳区的打卡记录
    ]
  },
  "timestamp": 1698765432000
}
```

**验证要点：**
- ✅ `countyStatistics` 为null（权限隔离）
- ✅ `checkinDetails` 仅包含朝阳区的5条打卡记录
- ✅ 不包含其他县域的数据

---

### 测试用例3️⃣: 验证返回数据的完整性

**测试内容：**

验证 `countyStatistics` 中的每个字段：

```json
{
  "countyCode": "001",           // ✅ 县域编码
  "countyName": "朝阳区",         // ✅ 县域名称
  "participatingPoints": 5,       // ✅ 教学点数量
  "totalAttendees": 150,          // ✅ 累计参与人数
  "totalCheckins": 5              // ✅ 打卡记录数
}
```

验证 `checkinDetails` 中的每条记录：

```json
{
  "id": 1,                              // ✅ 打卡ID
  "teachingPointId": 1,                 // ✅ 教学点ID
  "teachingPointName": "朝阳区第一小学",  // ✅ 教学点名称
  "countyCode": "001",                  // ✅ 县域编码
  "countyName": "朝阳区",                // ✅ 县域名称
  "attendeeCount": 30,                  // ✅ 参与人数
  "submittedTime": "2024-10-30T14:30:00" // ✅ 提交时间
}
```

---

### 测试用例4️⃣: 错误场景测试

#### 场景1: 活动不存在
```bash
curl -X GET "http://localhost:8080/api/activities/9999/county-statistics" \
  -H "Authorization: Bearer {token}"

# 预期: 404 活动不存在
```

#### 场景2: 无效的JWT token
```bash
curl -X GET "http://localhost:8080/api/activities/1/county-statistics" \
  -H "Authorization: Bearer invalid_token"

# 预期: 401 未授权
```

#### 场景3: 县级管理员访问不属于自己的活动
```bash
# 假设有另外一个活动，属于丰台区
curl -X GET "http://localhost:8080/api/activities/2/county-statistics" \
  -H "Authorization: Bearer {朝阳区管理员_token}"

# 预期: 403 禁止访问（如果权限校验严格）
# 或返回该管理员有权限的数据
```

---

## 📊 性能测试

### 测试条件

使用测试数据进行性能基准测试：

```bash
# 发送100个并发请求
ab -c 100 -n 100 -H "Authorization: Bearer {token}" \
  "http://localhost:8080/api/activities/1/county-statistics"
```

### 预期结果

| 指标 | 预期值 |
|------|--------|
| 平均响应时间 | < 100ms |
| 95分位响应时间 | < 300ms |
| 99分位响应时间 | < 500ms |
| 成功率 | 100% |
| 吞吐量 | > 50 req/s |

---

## 🔍 调试技巧

### 1️⃣ 查看数据库中的实际数据

```sql
-- 查看活动ID
SELECT id, name, status FROM activities WHERE name = '2024年秋季教学活动';

-- 查看县域统计的SQL执行结果
SELECT 
    COALESCE(tp.county_code, 'UNKNOWN') as countyCode,
    COUNT(DISTINCT c.teaching_point_id) as participatingPoints,
    COALESCE(SUM(c.attendee_count), 0) as totalAttendees,
    COUNT(*) as totalCheckins
FROM checkins c
LEFT JOIN teaching_points tp ON c.teaching_point_id = tp.id
WHERE c.activity_id = 1
GROUP BY tp.county_code
ORDER BY tp.county_code;

-- 查看打卡详情
SELECT 
    c.id, c.teaching_point_id, tp.name, tp.county_code,
    c.attendee_count, c.submitted_time
FROM checkins c
LEFT JOIN teaching_points tp ON c.teaching_point_id = tp.id
WHERE c.activity_id = 1
ORDER BY tp.county_code, c.submitted_time DESC;
```

### 2️⃣ 检查权限隔离

```sql
-- 查看管理员角色和县域信息
SELECT id, username, role, county_code FROM admins 
WHERE username IN ('city_admin', 'chaoyang_admin', 'fengtai_admin', 'dongcheng_admin');

-- 模拟权限检查
SELECT 
    c.id, c.teaching_point_id, tp.name, tp.county_code
FROM checkins c
LEFT JOIN teaching_points tp ON c.teaching_point_id = tp.id
WHERE c.activity_id = 1
AND (
    -- 市级管理员: 看全部
    '市级管理员' = '市级管理员'
    -- 或县级管理员: 只看本县
    OR tp.county_code = '001'
)
ORDER BY tp.county_code;
```

### 3️⃣ 查看API日志

在应用日志中搜索相关请求：

```
getCountyCheckinStatistics - 查询活动的县域打卡统计
buildCountyCheckinStatistics - 构建县域统计
buildCheckinDetails - 构建打卡详情
```

---

## 📝 常见问题

### Q1: 查询返回的 `countyStatistics` 为null（市级管理员）

**原因：** 权限判断逻辑有问题

**排查步骤：**
1. 检查JWT token中的角色信息是否正确为 `city`
2. 在代码中添加日志，查看 `adminRole` 是否正确
3. 验证 `if ("city".equals(adminRole))` 这行逻辑

### Q2: 打卡详情中缺少某个教学点

**原因：** 该教学点没有打卡记录

**解决方法：**
1. 检查 `checkins` 表中是否有该教学点的打卡记录
2. 检查SQL中的 `WHERE c.activity_id = ?` 条件

### Q3: `totalAttendees` 计算错误

**原因：** SUM聚合出错或数据不完整

**排查：**
```sql
-- 验证数据
SELECT 
    SUM(attendee_count),
    COUNT(*),
    GROUP_CONCAT(attendee_count)
FROM checkins 
WHERE activity_id = 1;
```

### Q4: 响应很慢（>1000ms）

**原因：** 
- 缺少数据库索引
- 数据量过大
- 网络问题

**优化方法：**
1. 添加推荐的数据库索引
2. 检查SQL执行计划：`EXPLAIN SELECT ...`
3. 增加数据库连接池大小

---

## 📚 参考资源

- [方案1实现完成总结](./方案1实现完成总结-县域统计需求.md) - 详细API文档
- [方案1实现快速集成指南](./方案1实现快速集成指南.md) - 集成步骤
- [各模块实现的具体功能](./各模块实现的具体功能.md) - 系统功能说明
- 数据库脚本：`sql/test_county_statistics_data.sql`

---

## ✅ 测试检查清单

在进行功能测试时，请检查以下项目：

### 数据导入
- [ ] 测试数据脚本已成功执行
- [ ] 3个县域已创建
- [ ] 15个教学点已创建
- [ ] 1个活动已创建（状态为ongoing）
- [ ] 15条打卡记录已创建
- [ ] 15条评价记录已创建
- [ ] 3个县级管理员账号已创建
- [ ] 确认系统市级管理员存在（无需创建）

### 功能测试
- [ ] 市级管理员能查看全部3个县域统计
- [ ] 县级管理员看不到 countyStatistics
- [ ] 打卡详情包含正确的字段
- [ ] 数据按县域正确分组
- [ ] 参与人数统计正确
- [ ] 教学点数量统计正确

### 权限测试
- [ ] 系统市级管理员可访问接口
- [ ] chaoyang_admin (朝阳区) 可访问接口
- [ ] fengtai_admin (丰台区) 可访问接口
- [ ] dongcheng_admin (东城区) 可访问接口
- [ ] 无效token被拒绝
- [ ] 不存在的活动返回404

### 性能测试
- [ ] 单个请求 < 100ms
- [ ] 并发100请求成功率 100%
- [ ] 无内存泄漏
- [ ] 无数据库连接泄漏

---

**文档版本：** v1.0  
**最后更新：** 2024-10-31  
**状态：** ✅ 已完成


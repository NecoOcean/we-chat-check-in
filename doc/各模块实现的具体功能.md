# 各模块实现的具体功能

**文档版本：** v1.2.0  
**更新日期：** 2024-11-01  
**系统：** 微信打卡系统

---

## 目录

1. [活动管理模块](#活动管理模块)
2. [二维码管理模块](#二维码管理模块)
3. [打卡参与模块](#打卡参与模块)
4. [活动评价模块](#活动评价模块)
5. [用户管理模块](#用户管理模块)
6. [教学点管理模块](#教学点管理模块)

---

## 活动管理模块

### 创建活动

- **管理员创建活动后，自动生成打卡和评价二维码**
  - 打卡二维码：用于活动期间的签到
  - 评价二维码：用于活动结束后的评价
  
- **打卡二维码的有效期**
  - 开始时间：由管理员在创建活动时设定
  - 结束时间：由管理员在创建活动时设定
  - 有效期计算：活动结束时间 + 7 天（用于事后评价）
  
- **二维码状态管理**
  - 创建时默认为 `ENABLED`（启用状态）
  - 活动进行中，打卡二维码可用
  - 活动结束后，打卡二维码自动禁用，评价二维码保持可用

### 结束活动

- **结束方式选择**
  - 管理员可选择 **手动结束活动** 或 **到期后自动结束**
  - 手动结束：立即生效
  - 自动结束：按照设定的结束时间自动执行

- **结束时自动生成评价二维码**
  - 若活动创建时未生成评价二维码，结束时自动生成
  - 评价二维码有效期：活动结束时间 + 7 天

- **结束时间确定规则**
  - **手动结束**：以当前操作时间点为结束时间
  - **自动结束**：以 **创建活动时设定的结束时间** 为结束时间
  - 手动结束可能早于自动结束时间

- **二维码自动禁用**
  - 活动结束时，自动禁用 **打卡二维码**
  - 保留 **评价二维码**，允许活动结束后进行评价
  - 评价二维码保持可用直到过期

### 查看活动列表

- **权限隔离**
  - **市级管理员**：可查看 **所有活动列表**（全市范围）
  - **县级管理员**：只能查看 **本县所有的活动信息**
  
- **活动列表过滤**
  - 管理员可根据 **县域** 划分查看活动列表
  - 管理员可按 **活动状态** 筛选（进行中/已结束）
  - 管理员可按 **创建时间** 排序

- **列表展示字段**
  - 活动名称
  - 活动描述
  - 活动状态（进行中/已结束）
  - 活动时间（开始时间/结束时间）
  - 创建人和创建时间
  - 参与教学点数
  - 累计参与人数

### 查询活动详情

- **活动基本信息展示**
  - 活动名称、描述、状态
  - 活动时间（开始/结束）
  - 创建人信息、创建时间
  - 活动范围（全市/指定县域）

- **活动参与统计**
  - **已参与教学点数**：有打卡记录的教学点数量
  - **累计参与人数**：所有参与教学点的人数总和
  - **已评价教学点数**：提交评价的教学点数量

- **二维码信息展示**
  - 打卡二维码：token、二维码图片、过期时间、状态
  - 评价二维码：token、二维码图片、过期时间、状态
  - 二维码扫描URL（用于前端展示）

- **权限检查**
  - 市级管理员可查看全市任何活动详情
  - 县级管理员只能查看本县活动详情

---

## 二维码管理模块

### 生成二维码

- **支持的二维码类型**
  - **打卡二维码 (CHECKIN)**：用于活动期间的签到
  - **评价二维码 (EVALUATION)**：用于活动结束后的评价

- **二维码生成过程**
  - 自动生成 JWT 令牌（包含二维码ID、活动ID、类型、过期时间）
  - 使用 HS512 算法对令牌进行加密签名
  - 使用 ZXing 库生成二维码图片（300x300 像素，Level H容错）
  - 将二维码图片编码为 Base64 格式存储

- **过期时间设置**
  - 默认过期时间：7 天
  - 可自定义过期时间
  - 过期后二维码自动失效，无法再次使用

### 验证二维码

- **验证流程**
  - 检查 JWT 签名是否有效
  - 检查二维码是否已过期
  - 检查二维码状态是否为启用（enabled）
  - 返回验证结果（成功/失败及原因）

- **验证结果返回信息**
  - 有效性标识（valid: true/false）
  - 二维码ID
  - 关联活动ID
  - 二维码类型
  - 失败原因（如果验证失败）

- **特定类型二维码验证**
  - 打卡时验证二维码类型必须为 CHECKIN
  - 评价时验证二维码类型必须为 EVALUATION
  - 类型不匹配时拒绝请求

### 禁用二维码

- **单个禁用**
  - 按二维码ID禁用指定的二维码
  - 记录禁用时间

- **批量禁用**
  - 一次禁用多个二维码
  - 例如：活动结束时禁用所有打卡二维码

- **按类型禁用**
  - 禁用特定类型的二维码
  - 示例：只禁用打卡二维码，保留评价二维码

- **选择性禁用**
  - 禁用除特定类型外的所有二维码
  - 示例：`disableQrCodesExcept(activityId, "evaluation")` - 禁用打卡但保留评价

### 查询二维码信息

- **分页查询**
  - 按活动ID查询该活动的所有二维码
  - 按二维码类型过滤
  - 按状态过滤（启用/禁用）
  - 支持分页显示

- **详情查询**
  - 根据二维码ID获取详细信息
  - 根据二维码Token获取信息
  - 返回完整的二维码信息（包括二维码图片）

---

## 打卡参与模块

### 提交打卡

- **打卡前置条件验证**
  - **二维码验证**
    - 二维码令牌必须有效
    - 二维码必须为打卡类型（CHECKIN）
    - 二维码必须未过期
    - 二维码必须处于启用状态
  
  - **活动状态验证**
    - 活动必须存在
    - 活动必须处于进行中状态
    - 当前时间必须在活动开始时间之后
    - 当前时间必须在活动结束时间之前
  
  - **幂等性检查**
    - 同一活动、同一教学点只能打卡一次
    - 防止重复打卡
    - 重复打卡时返回错误信息

- **打卡数据记录**
  - 打卡时间：系统当前时间
  - 活动ID：来自二维码
  - 教学点ID：来自请求参数
  - 参与人数：来自请求参数
  - 关联二维码ID：来自二维码

### 查询打卡记录

- **分页查询**
  - 按活动ID查询该活动的所有打卡记录
  - 按教学点ID查询该教学点的打卡记录
  - 支持多条件组合查询
  - 按打卡时间倒序排列

- **查询结果展示**
  - 打卡ID
  - 关联活动名称
  - 教学点ID
  - 参与人数
  - 打卡时间
  - 使用的二维码ID

### 统计打卡信息

- **参与统计**
  - **已参与教学点数**：不同的教学点数量
  - **累计参与人数**：所有打卡记录中参与人数的总和
  
- **统计准确性**
  - 使用数据库聚合函数计算
  - 每个教学点无论打卡多少次，只计算为1个参与点
  - 参与人数是每次打卡报备人数的累计

---

## 活动评价模块

### 提交评价

- **评价前置条件验证**
  - **二维码验证**
    - 二维码令牌必须有效
    - 二维码必须为评价类型（EVALUATION）
    - 二维码必须未过期
    - 二维码必须处于启用状态
  
  - **活动状态验证**
    - 活动必须存在
    - 活动必须处于已结束状态
    - 评价只能在活动结束后进行
  
  - **参与权限验证**
    - 教学点必须在该活动中有打卡记录
    - 必须先参与活动才能评价
    - 防止未参与的教学点进行评价
  
  - **重复评价检查**
    - 同一活动、同一教学点只能评价一次
    - 防止重复评价
    - 重复评价时返回错误信息

- **评价数据记录**
  - 问题1满意度（q1Satisfaction）：1-5分
  - 问题2实用性（q2Practicality）：1-5分
  - 问题3质量（q3Quality）：1-5分
  - 建议文本（suggestionText）：可选
  - 提交时间：系统当前时间
  - 关联二维码ID：来自二维码

### 查询评价列表

- **分页查询**
  - 按活动ID查询该活动的所有评价
  - 按教学点ID查询该教学点的评价
  - 支持多条件组合查询
  - 按提交时间倒序排列

- **权限控制**
  - 市级管理员可查看全市所有评价
  - 县级管理员只能查看本县范围的评价
  - 管理员可根据县域查看评价数据

- **查询结果展示**
  - 评价ID
  - 关联活动ID
  - 教学点ID
  - 各问题评分
  - 建议文本
  - 提交时间

### 统计评价信息

- **基础统计**
  - **总评价数**：该活动收到的评价总数
  - **评价教学点数**：提交评价的教学点数量

- **评分统计**
  - **各问题平均分**
    - 问题1满意度平均分
    - 问题2实用性平均分
    - 问题3质量平均分
  
- **评分分布**
  - **各分数等级数量**
    - 5分（非常满意）的数量
    - 4分（满意）的数量
    - 3分（一般）的数量
    - 2分（不满意）的数量
    - 1分（非常不满意）的数量

- **建议统计**
  - **包含建议的评价数**：有填写建议文本的评价数量

- **统计用途**
  - 评价汇总报表
  - 活动质量评估
  - 改进方向识别

---

## 模块间数据流

```
活动创建
    ↓
[二维码管理] 自动生成打卡二维码
    ↓
活动进行中
    ↓
[打卡参与] 教学点扫码打卡
    ↓
活动结束
    ↓
[二维码管理] 禁用打卡二维码，保留评价二维码
[二维码管理] 自动生成评价二维码
    ↓
[活动评价] 教学点扫码评价
    ↓
[活动管理] 查看活动详情和统计数据
```

---

## 用户管理模块

### 创建管理员账号

- **市级管理员专属功能**
  - 创建县级管理员账号
  - 设置初始密码（BCrypt加密）
  - 指定归属县域
  - 自动设置为启用状态

### 管理员账号管理

- **更新管理员信息**
  - 修改用户名
  - 修改归属县域
  - 用户名唯一性检查

- **密码管理**
  - 重置密码（市级管理员）
  - 修改密码（管理员自己）
  - BCrypt加密存储

- **状态管理**
  - 启用账号
  - 禁用账号
  - 软删除账号（数据保留）

### 查询管理员信息

- **详情查询**
  - 查询指定管理员信息
  - 返回完整账号信息

- **列表查询**
  - 分页查询管理员列表
  - 按角色过滤
  - 按县域过滤
  - 按状态过滤
  - 默认不显示已删除账号

---

## 教学点管理模块

### 创建教学点

- **管理员创建教学点**
  - 市级和县级管理员均可创建
  - 设置教学点名称和归属县域
  - 同县域内名称唯一性检查
  - 自动设置为启用状态

### 教学点管理

- **更新教学点信息**
  - 修改教学点名称
  - 修改归属县域
  - 支持部分更新
  - 名称唯一性检查

- **状态管理**
  - 启用教学点
  - 禁用教学点
  - 软删除教学点（数据保留）
  - 已删除教学点不可恢复

### 查询教学点信息

- **详情查询**
  - 查询指定教学点信息
  - 返回完整教学点信息（含县域名称）

- **列表查询**
  - 分页查询教学点列表
  - 名称模糊查询
  - 按县域过滤（市级管理员可用）
  - 按状态过滤
  - 按创建时间倒序
  - 默认不显示已删除教学点

- **权限隔离**
  - 市级管理员可查看所有教学点
  - 县级管理员只能查看本县教学点

---

## 功能总结表

| 模块 | 主要功能 | 核心操作 | 权限控制 |
|------|---------|---------|---------|
| **活动管理** | 活动生命周期 | 创建、结束、查询、统计 | 市级查全部，县级查本县 |
| **二维码管理** | 二维码生成验证 | 生成、验证、禁用、查询 | 管理员操作 |
| **打卡参与** | 活动签到 | 提交、查询、统计 | 需要有效二维码 |
| **活动评价** | 活动反馈 | 提交、查询、统计 | 需先参与，活动结束后 |
| **用户管理** | 管理员账号管理 | 创建、更新、删除、查询 | 仅市级管理员 |
| **教学点管理** | 教学点数据管理 | 创建、更新、删除、查询 | 市级查全部，县级查本县 |

---

## 注意事项

1. **时间序列**
   - 打卡只在活动进行中进行
   - 评价只在活动结束后进行
   - 不能颠倒顺序

2. **二维码生命周期**
   - 创建→启用→（打卡中）→禁用/保留→过期
   - 打卡二维码：创建→启用→禁用→过期
   - 评价二维码：创建→启用→过期

3. **权限隔离**
   - 全市管理员和县级管理员权限不同
   - 参与端无需登录，只需扫码
   - 二维码验证是参与端的唯一认证方式

4. **数据一致性**
   - 活动结束时必须禁用打卡二维码
   - 评价必须基于已打卡的教学点
   - 统计数据基于实际提交记录


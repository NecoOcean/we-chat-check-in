# å¾®ä¿¡æ‰“å¡ç³»ç»Ÿ - æ¨¡å—è®¾è®¡åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

å¯¹ç³»ç»Ÿå››ä¸ªæ ¸å¿ƒæ¨¡å—è¿›è¡Œäº†æ·±å…¥åˆ†æï¼Œæ•´ä½“è®¾è®¡**åŸºæœ¬åˆç†**ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜éœ€è¦ä¼˜åŒ–ï¼š

| é—®é¢˜ | ä¸¥é‡çº§ | æ¨¡å—æ¶‰åŠ | å»ºè®® |
|------|--------|---------|------|
| äºŒç»´ç ç±»å‹ä¸ä¸šåŠ¡æµç¨‹è€¦åˆä¸å¤Ÿæ¸…æ™° | ä¸­ | QrCode/Checkin/Evaluation | å¼ºåŒ–äºŒç»´ç çŠ¶æ€æœºè®¾è®¡ |
| äºŒç»´ç ä¾èµ–è·¨æ¨¡å—è°ƒç”¨ | ä¸­ | Activityâ†’QrCodeâ†’Checkin | ç»Ÿä¸€äºŒç»´ç ç”Ÿå‘½å‘¨æœŸç®¡ç†å…¥å£ |
| æ‰“å¡æ¨¡å—æ ¡éªŒé€»è¾‘å¤æ‚ | ä¸­ | Checkin | æå–ä¸ºç‹¬ç«‹çš„æ ¡éªŒæœåŠ¡ |
| æ´»åŠ¨ä¸äºŒç»´ç çš„è‡ªåŠ¨åŒ–é€»è¾‘ä¾µå…¥ | ä½ | Activity | è€ƒè™‘äº‹ä»¶é©±åŠ¨è®¾è®¡ |

---

## ä¸€ã€æ¨¡å—æ¶æ„åˆ†æ

### 1.1 å››ä¸ªæ ¸å¿ƒæ¨¡å—æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ´»åŠ¨ç®¡ç†æ¨¡å— (Activity)                â”‚
â”‚  â€¢ åˆ›å»ºæ´»åŠ¨ â†’ è‡ªåŠ¨ç”ŸæˆäºŒç»´ç                               â”‚
â”‚  â€¢ ç»“æŸæ´»åŠ¨ â†’ è‡ªåŠ¨ç¦ç”¨äºŒç»´ç                               â”‚
â”‚  â€¢ æŸ¥è¯¢è¯¦æƒ… â†’ è¿”å›äºŒç»´ç ä¿¡æ¯                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                    â”‚
           â†“                                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  äºŒç»´ç ç®¡ç† (QrCode)    â”‚         â”‚  äºŒç»´ç éªŒè¯ (QrCode)    â”‚
â”‚  â€¢ ç”Ÿæˆæ‰“å¡äºŒç»´ç        â”‚         â”‚  â€¢ éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§       â”‚
â”‚  â€¢ ç”Ÿæˆè¯„ä»·äºŒç»´ç        â”‚         â”‚  â€¢ æ£€æŸ¥çŠ¶æ€å’Œè¿‡æœŸ       â”‚
â”‚  â€¢ ç¦ç”¨äºŒç»´ç            â”‚         â”‚  â€¢ è¿”å›éªŒè¯ç»“æœ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                   â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ‰“å¡æ¨¡å— (Checkin)    â”‚     â”‚   è¯„ä»·æ¨¡å— (Evaluation) â”‚
â”‚  â€¢ éªŒè¯äºŒç»´ç            â”‚     â”‚  â€¢ éªŒè¯äºŒç»´ç            â”‚
â”‚  â€¢ æ ¡éªŒæ‰“å¡æƒé™         â”‚     â”‚  â€¢ æ ¡éªŒè¯„ä»·æƒé™         â”‚
â”‚  â€¢ è®°å½•æ‰“å¡æ•°æ®         â”‚     â”‚  â€¢ è®°å½•è¯„ä»·æ•°æ®         â”‚
â”‚  â€¢ ç»Ÿè®¡æ‰“å¡ä¿¡æ¯         â”‚     â”‚  â€¢ ç»Ÿè®¡è¯„ä»·ä¿¡æ¯         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¨¡å—é—´ä¾èµ–å…³ç³»

```
we-chat-activity
    â””â”€â”€ ä¾èµ– â†’ we-chat-qrcode
    
we-chat-checkins
    â””â”€â”€ ä¾èµ– â†’ we-chat-qrcode
    â””â”€â”€ ä¾èµ– â†’ we-chat-activity
    
we-chat-evaluation
    â””â”€â”€ ä¾èµ– â†’ we-chat-qrcode
    â””â”€â”€ ä¾èµ– â†’ we-chat-activity
    â””â”€â”€ ä¾èµ– â†’ we-chat-checkins
```

---

## äºŒã€è¯¦ç»†è®¾è®¡åˆ†æ

### 2.1 äºŒç»´ç ç®¡ç†æ¨¡å— (we-chat-qrcode)

#### è®¾è®¡è¯„ä»·ï¼šâœ… è‰¯å¥½

**èŒè´£æ¸…æ™°ï¼š**
- ç”ŸæˆäºŒç»´ç ï¼ˆæ‰“å¡/è¯„ä»·ä¸¤ç§ç±»å‹ï¼‰
- ç®¡ç†äºŒç»´ç çŠ¶æ€ç”Ÿå‘½å‘¨æœŸ
- éªŒè¯äºŒç»´ç æœ‰æ•ˆæ€§
- ä½¿ç”¨JWTç­¾åä¿è¯å®‰å…¨

**ä¼˜ç‚¹ï¼š**
```
1. å•ä¸€èŒè´£åŸåˆ™ - ä»…å…³æ³¨äºŒç»´ç ç”Ÿæˆå’ŒéªŒè¯
2. ç±»å‹åŒºåˆ†æ¸…æ™° - é€šè¿‡ QrCodeTypeEnum åŒºåˆ†æ‰“å¡/è¯„ä»·
3. çŠ¶æ€ç®¡ç†å®Œå–„ - enabled/disabled/deleted ä¸‰æ€
4. å®‰å…¨æ€§è®¾è®¡ - JWTç­¾å + è¿‡æœŸæ§åˆ¶ + çŠ¶æ€æ£€éªŒ
5. æ¥å£åˆ’åˆ†åˆç† - ç®¡ç†ç«¯æ¥å£ vs å‚ä¸ç«¯æ¥å£
```

**ä»£ç ç¤ºä¾‹ï¼ˆéªŒè¯æµç¨‹ï¼‰ï¼š**
```java
// QrCodeServiceImpl.java - éªŒè¯äºŒç»´ç 
public QrCodeVerifyResultVO verifyQrCode(String token) {
    // 1. éªŒè¯JWTç­¾å
    if (!tokenProvider.validateToken(token)) {
        return invalid("äºŒç»´ç ä»¤ç‰Œæ— æ•ˆ");
    }
    
    // 2. æ£€æŸ¥è¿‡æœŸæ—¶é—´
    if (tokenProvider.isTokenExpired(token)) {
        return invalid("äºŒç»´ç å·²è¿‡æœŸ");
    }
    
    // 3. æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
    QrCode qrCode = qrCodeMapper.selectById(qrcodeId);
    if (!QrCodeStatusEnum.ENABLED.equals(qrCode.getStatus())) {
        return invalid("äºŒç»´ç å·²è¢«ç¦ç”¨");
    }
    
    // 4. è¿”å›éªŒè¯é€šè¿‡
    return valid(qrcodeId, activityId, type);
}
```

---

### 2.2 æ´»åŠ¨ç®¡ç†æ¨¡å— (we-chat-activity)

#### è®¾è®¡è¯„ä»·ï¼šâš ï¸ ä¸­ç­‰ï¼ˆæœ‰æ”¹è¿›ç©ºé—´ï¼‰

**èŒè´£èŒƒå›´ï¼š**
- æ´»åŠ¨åŸºæœ¬CRUDæ“ä½œ
- **æ–°å¢ï¼š** äºŒç»´ç è‡ªåŠ¨ç”Ÿæˆå’Œç¦ç”¨ï¼ˆv1.1.0ï¼‰

**å­˜åœ¨çš„é—®é¢˜ï¼š**

#### é—®é¢˜1ï¼šäºŒç»´ç è‡ªåŠ¨åŒ–é€»è¾‘ä¾µå…¥
```java
// ActivityServiceImpl.java - åˆ›å»ºæ´»åŠ¨æ—¶è‡ªåŠ¨ç”ŸæˆäºŒç»´ç 
@Transactional
public Long createActivity(CreateActivityRequest request, ...) {
    // ... åˆ›å»ºæ´»åŠ¨ ...
    
    // è‡ªåŠ¨ç”ŸæˆäºŒç»´ç  - è¿™æ˜¯Activityæ¨¡å—çš„èŒè´£å—ï¼Ÿ
    try {
        generateQrCodesForActivity(activity);
    } catch (Exception e) {
        log.error("äºŒç»´ç ç”Ÿæˆå¤±è´¥"); 
        // ç»§ç»­æ‰§è¡Œï¼Œä¸å›æ»š
    }
    
    return activity.getId();
}
```

**é—®é¢˜åˆ†æï¼š**
- âŒ Activity æ¨¡å—å…³æ³¨äº† QrCode çš„ç”Ÿæˆæ—¶æœº
- âŒ åˆ›å»ºæ´»åŠ¨çš„æˆåŠŸ/å¤±è´¥ä¸äºŒç»´ç ç”Ÿæˆè€¦åˆ
- âŒ å¦‚æœäºŒç»´ç æ¨¡å—è§„åˆ™å˜æ›´ï¼Œéœ€è¦ä¿®æ”¹ Activity ä»£ç 
- âŒ ä¸ç¬¦åˆ SRPï¼ˆå•ä¸€èŒè´£åŸåˆ™ï¼‰

**æ”¹è¿›å»ºè®®ï¼š**

æ–¹æ¡ˆA - äº‹ä»¶é©±åŠ¨ï¼ˆæ¨èï¼‰
```java
// æ–¹æ¡ˆï¼šä½¿ç”¨ Spring Event è§£è€¦
@Service
public class ActivityServiceImpl {
    private final ApplicationEventPublisher eventPublisher;
    
    @Transactional
    public Long createActivity(CreateActivityRequest request, ...) {
        Activity activity = new Activity();
        // ... è®¾ç½®å±æ€§ ...
        activityMapper.insert(activity);
        
        // å‘å¸ƒäº‹ä»¶ï¼Œç”± QrCode æ¨¡å—ç›‘å¬å¤„ç†
        eventPublisher.publishEvent(new ActivityCreatedEvent(activity));
        
        return activity.getId();
    }
}

// QrCode æ¨¡å—ç›‘å¬
@Service
public class QrCodeEventListener {
    @EventListener
    public void onActivityCreated(ActivityCreatedEvent event) {
        Activity activity = event.getActivity();
        // ç”ŸæˆäºŒç»´ç 
        generateQrCodesForActivity(activity);
    }
}
```

æ–¹æ¡ˆB - æ˜¾å¼APIè°ƒç”¨ï¼ˆæ¬¡ä¼˜ï¼‰
```java
// ç”±æ§åˆ¶å™¨å±‚æ˜¾å¼è°ƒç”¨
@PostMapping("/activities")
public Result<Long> createActivity(@RequestBody CreateActivityRequest request) {
    // 1. åˆ›å»ºæ´»åŠ¨
    Long activityId = activityService.createActivity(request, ...);
    
    // 2. æ˜ç¡®ç”ŸæˆäºŒç»´ç ï¼ˆå¯é€‰å¤±è´¥ç»§ç»­ï¼‰
    try {
        qrCodeService.generateCheckinQrCode(activityId);
        qrCodeService.generateEvaluationQrCode(activityId);
    } catch (Exception e) {
        log.warn("äºŒç»´ç ç”Ÿæˆå¤±è´¥");
    }
    
    return success(activityId);
}
```

#### é—®é¢˜2ï¼šäºŒç»´ç ç¦ç”¨é€»è¾‘ä¸å®Œæ•´
```java
// æ´»åŠ¨ç»“æŸæ—¶çš„ç¦ç”¨é€»è¾‘
private void disableQrCodesForActivity(Long activityId) {
    // åªç¦ç”¨ CHECKIN äºŒç»´ç ï¼Œä¿ç•™ EVALUATION äºŒç»´ç 
    for (QrCode qrCode : qrCodes) {
        if (QrCodeTypeEnum.CHECKIN.equals(qrCode.getType())) {
            qrCodeService.disableQrCode(qrCode.getId());
        } else if (QrCodeTypeEnum.EVALUATION.equals(qrCode.getType())) {
            log.debug("ä¿ç•™è¯„ä»·äºŒç»´ç ");
        }
    }
}
```

**é—®é¢˜åˆ†æï¼š**
- âœ… ä¸šåŠ¡é€»è¾‘æ­£ç¡®ï¼ˆä¿ç•™è¯„ä»·äºŒç»´ç ç”¨äºæ´»åŠ¨ç»“æŸåè¯„ä»·ï¼‰
- âš ï¸ ä½†æ­¤é€»è¾‘"ç¡¬ç¼–ç "åœ¨ Activity æ¨¡å—
- âš ï¸ å¦‚æœè¯„ä»·æ¨¡å—è§„åˆ™å˜æ›´ï¼ˆå¦‚ä¸å†æ”¯æŒäº‹åè¯„ä»·ï¼‰ï¼Œéœ€è¦æ”¹è¿™é‡Œ
- âš ï¸ äºŒç»´ç çš„ç¦ç”¨ç­–ç•¥åº”ç”± QrCode æ¨¡å—å†³å®š

**æ”¹è¿›å»ºè®®ï¼š**

å°†ç­–ç•¥ä¸‹æ²‰åˆ° QrCode æ¨¡å—
```java
// QrCodeService.java - æ·»åŠ æ–°æ–¹æ³•
public interface QrCodeService {
    // ç¦ç”¨ç‰¹å®šç±»å‹çš„äºŒç»´ç 
    void disableQrCodesByType(Long activityId, QrCodeTypeEnum type);
    
    // ç¦ç”¨é™¤æŸç±»å‹å¤–çš„æ‰€æœ‰äºŒç»´ç 
    void disableQrCodesExcept(Long activityId, QrCodeTypeEnum... excludedTypes);
}

// ä½¿ç”¨ç¤ºä¾‹
@Override
public void finishActivity(Long activityId, ...) {
    // ...æ›´æ–°æ´»åŠ¨çŠ¶æ€...
    
    // ç¦ç”¨æ‰“å¡äºŒç»´ç ï¼Œä¿ç•™è¯„ä»·äºŒç»´ç 
    qrCodeService.disableQrCodesExcept(activityId, QrCodeTypeEnum.EVALUATION);
}
```

---

### 2.3 æ‰“å¡æ¨¡å— (we-chat-checkins)

#### è®¾è®¡è¯„ä»·ï¼šâš ï¸ ä¸­ç­‰ï¼ˆé‡é‡çº§ï¼‰

**èŒè´£èŒƒå›´ï¼š**
- æ¥æ”¶æ‰“å¡è¯·æ±‚
- éªŒè¯äºŒç»´ç ã€æ´»åŠ¨ã€æ‰“å¡æƒé™
- è®°å½•æ‰“å¡æ•°æ®
- ç»Ÿè®¡æ‰“å¡ä¿¡æ¯

**å­˜åœ¨çš„é—®é¢˜ï¼š**

#### é—®é¢˜1ï¼šéªŒè¯é€»è¾‘å¤æ‚ä¸”é‡å¤

```java
// CheckinServiceImpl.java - submitCheckin æ–¹æ³•ä¸­çš„éªŒè¯
public CheckinSubmitResponseVO submitCheckin(CheckinSubmitRequest request) {
    // 1. éªŒè¯äºŒç»´ç 
    QrCodeVerifyResultVO verifyResult = qrCodeService.verifyQrCode(request.getToken());
    if (!verifyResult.getValid()) {
        throw new BusinessException(1501, "äºŒç»´ç æ— æ•ˆ");
    }
    
    // 2. éªŒè¯äºŒç»´ç ç±»å‹
    QrCode qrCode = qrCodeMapper.selectById(verifyResult.getQrcodeId());
    if (ObjectUtil.isNull(qrCode) || !QrCodeTypeEnum.CHECKIN.equals(qrCode.getType())) {
        throw new BusinessException(1501, "äºŒç»´ç æ— æ•ˆ");
    }
    
    Long activityId = qrCode.getActivityId();
    
    // 3. éªŒè¯æ´»åŠ¨å­˜åœ¨
    Activity activity = activityMapper.selectById(activityId);
    if (ObjectUtil.isNull(activity)) {
        throw new BusinessException(1301, "æ´»åŠ¨ä¸å­˜åœ¨");
    }
    
    // 4. éªŒè¯æ´»åŠ¨çŠ¶æ€ - å¤šä¸ªæ¡ä»¶æ£€æŸ¥
    if (!ActivityStatusEnum.ONGOING.equals(activity.getStatus())) {
        throw new BusinessException(1303, "æ´»åŠ¨å·²ç»“æŸ");
    }
    if (LocalDateTime.now().isBefore(activity.getStartTime())) {
        throw new BusinessException(1302, "æ´»åŠ¨æœªå¼€å§‹");
    }
    if (LocalDateTime.now().isAfter(activity.getEndTime())) {
        throw new BusinessException(1303, "æ´»åŠ¨å·²ç»“æŸ");
    }
    
    // 5. æ£€æŸ¥å¹‚ç­‰æ€§
    LambdaQueryWrapper<Checkin> queryWrapper = new LambdaQueryWrapper<>();
    queryWrapper.eq(Checkin::getActivityId, activityId)
               .eq(Checkin::getTeachingPointId, request.getTeachingPointId());
    Checkin existingCheckin = checkinMapper.selectOne(queryWrapper);
    if (ObjectUtil.isNotNull(existingCheckin)) {
        throw new BusinessException(1402, "è¯¥æ•™å­¦ç‚¹å·²æ‰“å¡");
    }
    
    // ... æœ€åæ‰è®°å½•æ‰“å¡ ...
}
```

**é—®é¢˜åˆ†æï¼š**
```
éªŒè¯é€»è¾‘æ··åœ¨ä¸šåŠ¡æµç¨‹ä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. âŒ ä»£ç è¡Œæ•°è¿‡å¤šï¼ˆ20+ è¡ŒéªŒè¯ï¼‰
2. âŒ éªŒè¯æ­¥éª¤é¡ºåºå›ºå®šï¼Œéš¾ä»¥å˜æ›´
3. âŒ åŒæ ·çš„éªŒè¯é€»è¾‘å¯èƒ½åœ¨ Evaluation æ¨¡å—é‡å¤
4. âŒ å¦‚æœæ´»åŠ¨æ¨¡å—çš„çŠ¶æ€æ£€éªŒè§„åˆ™å˜æ›´ï¼Œéœ€è¦åŒæ—¶ä¿®æ”¹è¿™é‡Œ
5. âŒ éš¾ä»¥å•ç‹¬æµ‹è¯•æ¯ä¸ªéªŒè¯æ­¥éª¤
```

**å¯¹æ¯” Evaluation æ¨¡å—çš„ç±»ä¼¼ä»£ç ï¼š**
```java
// EvaluationServiceImpl.java - submitEvaluation ä¸­çš„éªŒè¯
public EvaluationSubmitResponseVO submitEvaluation(EvaluationSubmitRequest request) {
    // 1. éªŒè¯äºŒç»´ç 
    QrCodeVerifyResultVO verifyResult = qrCodeService.verifyQrCode(request.getToken());
    
    // 2. éªŒè¯äºŒç»´ç ç±»å‹
    QrCode qrCode = qrCodeMapper.selectById(verifyResult.getQrcodeId());
    if (!QrCodeTypeEnum.EVALUATION.equals(qrCode.getType())) {
        throw new BusinessException(1501, "äºŒç»´ç æ— æ•ˆ");
    }
    
    // 3. éªŒè¯æ´»åŠ¨å­˜åœ¨
    Activity activity = activityMapper.selectById(activityId);
    
    // 4. éªŒè¯æ´»åŠ¨çŠ¶æ€ - è¯„ä»·è¦æ±‚æ´»åŠ¨å·²ç»“æŸ
    if (!ActivityStatusEnum.ENDED.equals(activity.getStatus())) {
        throw new BusinessException(1304, "æ´»åŠ¨æœªç»“æŸ");
    }
    
    // 5. æ£€æŸ¥æ˜¯å¦å·²å‚ä¸æ´»åŠ¨ï¼ˆæ‰“å¡ï¼‰
    Checkin checkin = checkinMapper.selectOne(...);
    if (checkin == null) {
        throw new BusinessException(1601, "æ•™å­¦ç‚¹æœªå‚ä¸");
    }
    
    // 6. æ£€æŸ¥æ˜¯å¦å·²è¯„ä»·
    Evaluation existingEvaluation = evaluationMapper.selectOne(...);
    if (existingEvaluation != null) {
        throw new BusinessException(1602, "å·²è¯„ä»·");
    }
}
```

**é—®é¢˜ï¼š** æ‰“å¡å’Œè¯„ä»·çš„éªŒè¯é€»è¾‘é‡å¤ 70% ä»¥ä¸Šï¼

#### é—®é¢˜2ï¼šç¼ºä¹ç‹¬ç«‹çš„éªŒè¯æœåŠ¡

**æ”¹è¿›å»ºè®®ï¼š**

æå–éªŒè¯é€»è¾‘ä¸ºç‹¬ç«‹æœåŠ¡
```java
// CheckinValidator.java - æ–°å¢
@Service
public class CheckinValidator {
    private final QrCodeService qrCodeService;
    private final ActivityMapper activityMapper;
    private final CheckinMapper checkinMapper;
    
    public void validateQrCode(String token) {
        QrCodeVerifyResultVO result = qrCodeService.verifyQrCode(token);
        if (!result.getValid()) {
            throw new BusinessException(1501, "äºŒç»´ç æ— æ•ˆ");
        }
    }
    
    public QrCode validateCheckinQrCode(String token) {
        validateQrCode(token);
        QrCode qrCode = qrCodeService.getQrCodeByToken(token);
        if (!QrCodeTypeEnum.CHECKIN.equals(qrCode.getType())) {
            throw new BusinessException(1501, "è¯·ä½¿ç”¨æ‰“å¡äºŒç»´ç ");
        }
        return qrCode;
    }
    
    public Activity validateActivityOngoing(Long activityId) {
        Activity activity = activityMapper.selectById(activityId);
        if (activity == null) {
            throw new BusinessException(1301, "æ´»åŠ¨ä¸å­˜åœ¨");
        }
        
        LocalDateTime now = LocalDateTime.now();
        if (!ActivityStatusEnum.ONGOING.equals(activity.getStatus())) {
            throw new BusinessException(1303, "æ´»åŠ¨ä¸åœ¨è¿›è¡Œä¸­");
        }
        if (now.isBefore(activity.getStartTime())) {
            throw new BusinessException(1302, "æ´»åŠ¨æœªå¼€å§‹");
        }
        if (now.isAfter(activity.getEndTime())) {
            throw new BusinessException(1303, "æ´»åŠ¨å·²ç»“æŸ");
        }
        
        return activity;
    }
    
    public void validateCheckinIdempotent(Long activityId, Long teachingPointId) {
        LambdaQueryWrapper<Checkin> query = new LambdaQueryWrapper<>();
        query.eq(Checkin::getActivityId, activityId)
             .eq(Checkin::getTeachingPointId, teachingPointId);
        
        if (checkinMapper.exists(query)) {
            throw new BusinessException(1402, "è¯¥æ•™å­¦ç‚¹å·²æ‰“å¡");
        }
    }
}

// ä½¿ç”¨æ”¹è¿›åçš„ CheckinServiceImpl
@Service
public class CheckinServiceImpl implements CheckinService {
    private final CheckinValidator validator;
    private final CheckinMapper checkinMapper;
    
    @Override
    @Transactional
    public CheckinSubmitResponseVO submitCheckin(CheckinSubmitRequest request) {
        log.info("å¼€å§‹æäº¤æ‰“å¡");
        
        // ä½¿ç”¨éªŒè¯å™¨
        QrCode qrCode = validator.validateCheckinQrCode(request.getToken());
        Activity activity = validator.validateActivityOngoing(qrCode.getActivityId());
        validator.validateCheckinIdempotent(qrCode.getActivityId(), 
                                           request.getTeachingPointId());
        
        // è®°å½•æ‰“å¡
        Checkin checkin = Checkin.builder()
            .activityId(qrCode.getActivityId())
            .teachingPointId(request.getTeachingPointId())
            .attendeeCount(request.getAttendeeCount())
            .submittedTime(LocalDateTime.now())
            .sourceQrcodeId(qrCode.getId())
            .build();
        
        checkinMapper.insert(checkin);
        
        return CheckinSubmitResponseVO.builder()
            .success(true)
            .checkinId(checkin.getId())
            .build();
    }
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… éªŒè¯é€»è¾‘åˆ†ç¦»ï¼Œæ˜“äºæµ‹è¯•
- âœ… å‡å°‘é‡å¤ä»£ç 
- âœ… ä¾¿äºéªŒè¯è§„åˆ™å¤ç”¨
- âœ… ä¸šåŠ¡é€»è¾‘æ›´æ¸…æ™°

---

### 2.4 è¯„ä»·æ¨¡å— (we-chat-evaluation)

#### è®¾è®¡è¯„ä»·ï¼šâš ï¸ ä¸­ç­‰ï¼ˆéœ€è¦éªŒè¯å™¨å¤ç”¨ï¼‰

**èŒè´£èŒƒå›´ï¼š**
- è¯„ä»·æäº¤
- æƒé™æ ¡éªŒï¼ˆéœ€å…ˆå‚ä¸æ´»åŠ¨ï¼‰
- è¯„ä»·æŸ¥è¯¢å’Œç»Ÿè®¡

**å­˜åœ¨çš„é—®é¢˜ï¼š**

#### é—®é¢˜1ï¼šéªŒè¯é€»è¾‘é‡å¤

åŒ Checkin æ¨¡å—ï¼Œæœ‰å¤§é‡é‡å¤çš„éªŒè¯ä»£ç ã€‚

**æ”¹è¿›æ–¹æ¡ˆï¼š**

åˆ›å»ºç»Ÿä¸€çš„éªŒè¯å™¨
```java
// ParticipationValidator.java - è¯„ä»·å’Œæ‰“å¡å…±ç”¨
@Service
public class ParticipationValidator {
    private final QrCodeService qrCodeService;
    private final ActivityMapper activityMapper;
    private final CheckinMapper checkinMapper;
    
    public void validateQrCode(String token) {
        QrCodeVerifyResultVO result = qrCodeService.verifyQrCode(token);
        if (!result.getValid()) {
            throw new BusinessException(1501, "äºŒç»´ç æ— æ•ˆ");
        }
    }
    
    // éªŒè¯æ´»åŠ¨åœ¨è¿›è¡Œä¸­
    public Activity validateActivityOngoing(Long activityId) { ... }
    
    // éªŒè¯æ´»åŠ¨å·²ç»“æŸ
    public Activity validateActivityEnded(Long activityId) { ... }
    
    // éªŒè¯æ•™å­¦ç‚¹æ˜¯å¦å·²å‚ä¸æ´»åŠ¨
    public Checkin validateTeachingPointParticipated(Long activityId, Long teachingPointId) {
        Checkin checkin = checkinMapper.selectOne(
            new LambdaQueryWrapper<Checkin>()
                .eq(Checkin::getActivityId, activityId)
                .eq(Checkin::getTeachingPointId, teachingPointId)
        );
        
        if (checkin == null) {
            throw new BusinessException(1601, "æ•™å­¦ç‚¹æœªå‚ä¸æ´»åŠ¨");
        }
        
        return checkin;
    }
}

// åˆ™ Evaluation æ¨¡å—ç®€åŒ–ä¸º
@Service
public class EvaluationServiceImpl implements EvaluationService {
    private final ParticipationValidator validator;
    
    @Override
    @Transactional
    public EvaluationSubmitResponseVO submitEvaluation(EvaluationSubmitRequest request) {
        // éªŒè¯äºŒç»´ç ç±»å‹
        QrCode qrCode = qrCodeService.getQrCodeByToken(request.getToken());
        if (!QrCodeTypeEnum.EVALUATION.equals(qrCode.getType())) {
            throw new BusinessException(1501, "è¯·ä½¿ç”¨è¯„ä»·äºŒç»´ç ");
        }
        
        // éªŒè¯æ´»åŠ¨å·²ç»“æŸ
        Activity activity = validator.validateActivityEnded(qrCode.getActivityId());
        
        // éªŒè¯æ•™å­¦ç‚¹å·²å‚ä¸
        validator.validateTeachingPointParticipated(activity.getId(), 
                                                    request.getTeachingPointId());
        
        // æ£€æŸ¥æ˜¯å¦å·²è¯„ä»·
        this.checkDuplicateEvaluation(activity.getId(), request.getTeachingPointId());
        
        // æäº¤è¯„ä»·
        Evaluation evaluation = buildEvaluation(activity, request, qrCode);
        evaluationMapper.insert(evaluation);
        
        return buildResponse(evaluation);
    }
}
```

---

## ä¸‰ã€åŠŸèƒ½å†—ä½™åˆ†æ

### 3.1 äºŒç»´ç éªŒè¯çš„é‡å¤æ£€æŸ¥

| æ£€æŸ¥é¡¹ | Checkin | Evaluation | æ˜¯å¦å†—ä½™ |
|--------|--------|------------|---------|
| äºŒç»´ç ç­¾å | âœ“ QrCodeService.verifyQrCode | âœ“ QrCodeService.verifyQrCode | **å†—ä½™** |
| äºŒç»´ç çŠ¶æ€ | âœ“ (åœ¨verifyä¸­) | âœ“ (åœ¨verifyä¸­) | **å†—ä½™** |
| äºŒç»´ç è¿‡æœŸ | âœ“ (åœ¨verifyä¸­) | âœ“ (åœ¨verifyä¸­) | **å†—ä½™** |
| äºŒç»´ç ç±»å‹ | âœ“ æ£€æŸ¥CHECKIN | âœ“ æ£€æŸ¥EVALUATION | **åˆç†** |
| æ´»åŠ¨çŠ¶æ€ | âœ“ è¿›è¡Œä¸­ | âœ“ å·²ç»“æŸ | **åˆç†** |
| æƒé™ | Ã— | âœ“ éœ€å‚ä¸è¿‡ | **åˆç†** |

**åˆ†æï¼š** 
- äºŒç»´ç éªŒè¯å®Œå…¨é‡å¤ï¼ˆä¸åˆç†ï¼‰
- åº”è¯¥ç”± QrCodeService.verifyQrCode ä¸€æ¬¡å®Œæˆ
- ç±»å‹æ£€æŸ¥åº”è¯¥åˆå¹¶ä¸º `verifyQrCodeOfType(token, type)`

### 3.2 æ´»åŠ¨æ ¡éªŒçš„é‡å¤æ£€æŸ¥

| æ£€æŸ¥é¡¹ | CheckinServiceImpl | EvaluationServiceImpl | æ˜¯å¦å†—ä½™ |
|--------|------------------|-------------------|-|
| æ´»åŠ¨å­˜åœ¨æ€§ | âœ“ | âœ“ | **å†—ä½™** |
| æ´»åŠ¨çŠ¶æ€æ£€æŸ¥ | âœ“ (è¿›è¡Œä¸­) | âœ“ (å·²ç»“æŸ) | **åˆç†** |
| æ—¶é—´èŒƒå›´æ£€æŸ¥ | âœ“ (3ä¸ªæ£€æŸ¥) | Ã— | **éƒ¨åˆ†å†—ä½™** |

**åˆ†æï¼š**
- æ´»åŠ¨å­˜åœ¨æ€§æ£€æŸ¥é‡å¤ï¼ˆåº”æå–åˆ° ActivityValidatorï¼‰
- çŠ¶æ€æ£€æŸ¥é€»è¾‘åŸºæœ¬ç›¸åŒä½†æ¡ä»¶ä¸åŒï¼ˆåˆç†ï¼Œä½†å¯å…±ç”¨éªŒè¯å™¨ï¼‰

### 3.3 æ•°æ®åº“æŸ¥è¯¢çš„å†—ä½™

```java
// é—®é¢˜ï¼šæ‰“å¡æ¨¡å—æŸ¥è¯¢æ‰“å¡è®°å½•æ—¶çš„ç»Ÿè®¡
public CheckinStatisticsVO getCheckinStatistics(Long activityId) {
    Page<Checkin> page = new Page<>(1, Integer.MAX_VALUE);
    Page<Checkin> checkinPage = checkinMapper.selectPage(page, queryWrapper);
    
    long totalAttendees = checkinPage.getRecords().stream()
        .mapToLong(Checkin::getAttendeeCount)
        .sum();  // âŒ åº”è¯¥ç”¨æ•°æ®åº“ SUM å‡½æ•°
}

// æ”¹è¿›ï¼š
public CheckinStatisticsVO getCheckinStatistics(Long activityId) {
    Long totalAttendees = checkinMapper.sumAttendeeCount(activityId);  // SQL SUM
    Long participatingTeachingPoints = checkinMapper.countDistinctTeachingPoints(activityId);
    
    return CheckinStatisticsVO.builder()
        .totalAttendees(totalAttendees)
        .participatingTeachingPoints(participatingTeachingPoints)
        .build();
}
```

---

## å››ã€æ¶æ„è®¾è®¡æ€è·¯è¯„ä»·

### 4.1 æ ¸å¿ƒè®¾è®¡æ€è·¯ï¼ˆç¬¦åˆç³»ç»Ÿè®¾è®¡ï¼‰

```
âœ… æ¨¡å—åŒ–æ¶æ„
   â””â”€ å„æ¨¡å—ç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹ç»´æŠ¤

âœ… å…³æ³¨ç‚¹åˆ†ç¦» (Separation of Concerns)
   â””â”€ äºŒç»´ç æ¨¡å—ï¼šç”Ÿæˆå’ŒéªŒè¯
   â””â”€ æ‰“å¡æ¨¡å—ï¼šä¸šåŠ¡é€»è¾‘
   â””â”€ è¯„ä»·æ¨¡å—ï¼šä¸šåŠ¡é€»è¾‘

âœ… ä¸¤çº§æƒé™éš”ç¦»
   â””â”€ ç®¡ç†ç«¯æ¥å£ï¼ˆéœ€ç™»å½•ã€æœ‰æƒé™æ£€æŸ¥ï¼‰
   â””â”€ å‚ä¸ç«¯æ¥å£ï¼ˆæ— éœ€ç™»å½•ã€ä»…éªŒè¯äºŒç»´ç ï¼‰

âœ… ä¸šåŠ¡æµç¨‹æ¸…æ™°
   â””â”€ æ‰“å¡æµç¨‹ï¼šéªŒè¯ â†’ è®°å½• â†’ ç»Ÿè®¡
   â””â”€ è¯„ä»·æµç¨‹ï¼šéªŒè¯ â†’ æƒé™ â†’ è®°å½• â†’ ç»Ÿè®¡
```

### 4.2 ä¸ç¬¦åˆè®¾è®¡æ€è·¯çš„åœ°æ–¹

#### âŒ é—®é¢˜1ï¼šæ´»åŠ¨æ¨¡å—çš„èŒè´£è •å˜

```
åŸè®¾è®¡æ€è·¯ï¼š
æ´»åŠ¨ â†’ [ä»…ç®¡ç†æ´»åŠ¨CRUDå’Œç”Ÿå‘½å‘¨æœŸ]

å½“å‰è®¾è®¡ï¼š
æ´»åŠ¨ â†’ [CRUD + è‡ªåŠ¨ç”Ÿæˆ/ç¦ç”¨äºŒç»´ç ]

é—®é¢˜ï¼š
æ´»åŠ¨æ¨¡å—ä¸åº”è¯¥å…³å¿ƒ"ä½•æ—¶ç”ŸæˆäºŒç»´ç "çš„ç»†èŠ‚
è¿™è¿åäº† SRPï¼ˆå•ä¸€èŒè´£åŸåˆ™ï¼‰å’Œ DIPï¼ˆä¾èµ–å€’ç½®åŸåˆ™ï¼‰
```

#### âŒ é—®é¢˜2ï¼šéªŒè¯é€»è¾‘åˆ†æ•£

```
åŸè®¾è®¡æ€è·¯åº”è¯¥æ˜¯ï¼š
å‚ä¸ç«¯è¯·æ±‚ â†’ ç»Ÿä¸€çš„éªŒè¯å±‚ â†’ ä¸šåŠ¡å¤„ç†

å½“å‰è®¾è®¡ï¼š
æ‰“å¡è¯·æ±‚ â†’ CheckinService å†…éƒ¨éªŒè¯
è¯„ä»·è¯·æ±‚ â†’ EvaluationService å†…éƒ¨éªŒè¯

é—®é¢˜ï¼š
éªŒè¯é€»è¾‘æ•£è½åœ¨å„æ¨¡å—ï¼Œé‡å¤ç‡é«˜
éš¾ä»¥ç»´æŠ¤ç»Ÿä¸€çš„éªŒè¯ç­–ç•¥
```

#### âŒ é—®é¢˜3ï¼šè·¨æ¨¡å—è°ƒç”¨é“¾è¿‡é•¿

```
Activity
    â”œâ”€ è°ƒç”¨ QrCodeService
    â”‚   â””â”€ è°ƒç”¨ QrCodeMapper
    â”‚
Checkin
    â”œâ”€ è°ƒç”¨ QrCodeService
    â”œâ”€ è°ƒç”¨ ActivityMapper
    â””â”€ è°ƒç”¨ CheckinMapper
    
Evaluation
    â”œâ”€ è°ƒç”¨ QrCodeService
    â”œâ”€ è°ƒç”¨ ActivityMapper
    â”œâ”€ è°ƒç”¨ CheckinMapper
    â””â”€ è°ƒç”¨ EvaluationMapper

é£é™©ï¼š
- ä»»ä½•ä¸€ä¸ªæ¨¡å—çš„æ”¹åŠ¨éƒ½å¯èƒ½å½±å“å…¶ä»–æ¨¡å—
- å¾ªç¯ä¾èµ–å¯èƒ½æ€§é«˜
- éš¾ä»¥ç†è§£å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
```

---

## äº”ã€å»ºè®®ä¼˜åŒ–æ–¹æ¡ˆ

### 5.1 çŸ­æœŸä¼˜åŒ–ï¼ˆä½é£é™©ï¼Œç«‹å³å®æ–½ï¼‰

#### 1ï¸âƒ£ æå–éªŒè¯å™¨

```
ç›®æ ‡ï¼šæ¶ˆé™¤éªŒè¯é€»è¾‘é‡å¤

æ­¥éª¤ï¼š
1. åœ¨ common æ¨¡å—åˆ›å»º CheckinValidator/EvaluationValidator
2. å°†é‡å¤çš„éªŒè¯é€»è¾‘æå–åˆ°éªŒè¯å™¨
3. ä¿®æ”¹ CheckinServiceImpl å’Œ EvaluationServiceImpl ä½¿ç”¨éªŒè¯å™¨

é¢„æœŸæ•ˆæœï¼š
- ä»£ç è¡Œæ•°å‡å°‘ 30-40%
- éªŒè¯é€»è¾‘å•ä¸€èŒè´£
- ä¾¿äºç»Ÿä¸€ä¿®æ”¹éªŒè¯è§„åˆ™
```

#### 2ï¸âƒ£ ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢

```
ç›®æ ‡ï¼šä½¿ç”¨æ•°æ®åº“èšåˆè€Œéåº”ç”¨å±‚èšåˆ

ä¿®æ”¹é¡¹ï¼š
1. CheckinServiceImpl.getCheckinStatistics()
   - ä¿®æ”¹ä¸ºä½¿ç”¨æ•°æ®åº“ SUM/COUNT å‡½æ•°
   
2. EvaluationServiceImpl.queryEvaluationStatistics()
   - å·²æ­£ç¡®ä½¿ç”¨æ•°æ®åº“èšåˆï¼Œæ— éœ€ä¿®æ”¹

é¢„æœŸæ•ˆæœï¼š
- æ€§èƒ½æå‡ 10-20%ï¼ˆå‡å°‘å†…å­˜å ç”¨ï¼‰
- ä»£ç æ›´ç®€æ´
```

#### 3ï¸âƒ£ å¢å¼º QrCodeService æ¥å£

```
ç›®æ ‡ï¼šå°†äºŒç»´ç ç›¸å…³ç­–ç•¥ä¸‹æ²‰åˆ° QrCode æ¨¡å—

æ–°å¢æ¥å£æ–¹æ³•ï¼š
public interface QrCodeService {
    // æŒ‰ç±»å‹ç¦ç”¨äºŒç»´ç 
    void disableQrCodesByType(Long activityId, QrCodeTypeEnum type);
    
    // æŒ‰ç±»å‹ç¦ç”¨é™¤å¤–çš„äºŒç»´ç 
    void disableQrCodesExcept(Long activityId, QrCodeTypeEnum... excludedTypes);
    
    // éªŒè¯ç‰¹å®šç±»å‹çš„äºŒç»´ç 
    QrCodeVerifyResultVO verifyQrCodeOfType(String token, QrCodeTypeEnum type);
}

ä¿®æ”¹ ActivityServiceImplï¼š
- ä½¿ç”¨ qrCodeService.disableQrCodesExcept(activityId, EVALUATION)
- è€Œä¸æ˜¯è‡ªå·±åˆ¤æ–­äºŒç»´ç ç±»å‹

é¢„æœŸæ•ˆæœï¼š
- Activity æ¨¡å—èŒè´£æ›´æ¸…æ™°
- äºŒç»´ç ç­–ç•¥é›†ä¸­ç®¡ç†
```

### 5.2 ä¸­æœŸä¼˜åŒ–ï¼ˆä¸­ç­‰é£é™©ï¼Œ3-6ä¸ªæœˆåï¼‰

#### 1ï¸âƒ£ å®æ–½äº‹ä»¶é©±åŠ¨æ¶æ„

```
ç›®æ ‡ï¼šè§£è€¦ Activity å’Œ QrCode æ¨¡å—

è®¾è®¡ï¼š
Activity å‘å¸ƒäº‹ä»¶
    â”œâ”€ ActivityCreatedEvent â†’ QrCode æ¨¡å—ç›‘å¬ç”ŸæˆäºŒç»´ç 
    â””â”€ ActivityFinishedEvent â†’ QrCode æ¨¡å—ç›‘å¬ç¦ç”¨äºŒç»´ç 

ä¼˜ç‚¹ï¼š
- æ¨¡å—å®Œå…¨è§£è€¦
- æ˜“äºæ‰©å±•ï¼ˆå¦‚æ·»åŠ é€šçŸ¥æ¨¡å—ï¼‰
- ç¬¦åˆå¼€é—­åŸåˆ™ï¼ˆå¼€æ”¾æ‰©å±•ï¼Œå…³é—­ä¿®æ”¹ï¼‰

é£é™©ï¼š
- äº‹ä»¶å¤„ç†éœ€è¦å¼‚å¸¸å¤„ç†
- éœ€è¦è€ƒè™‘äº‹ä»¶é¡ºåºé—®é¢˜
```

#### 2ï¸âƒ£ åˆ›å»ºç»Ÿä¸€çš„å‚ä¸æµç¨‹åè°ƒå™¨

```
ç›®æ ‡ï¼šæ¶ˆé™¤è·¨æ¨¡å—è°ƒç”¨é“¾

è®¾è®¡ï¼š
æ–°å¢ ParticipationOrchestrator æœåŠ¡
    â”œâ”€ åè°ƒ Checkin æµç¨‹
    â”œâ”€ åè°ƒ Evaluation æµç¨‹
    â””â”€ éš”ç¦»åº•å±‚æ¨¡å—ç»†èŠ‚

ç¤ºä¾‹ï¼š
public class ParticipationOrchestrator {
    // æ‰“å¡ä¸»æµç¨‹
    public CheckinSubmitResponseVO submitCheckin(CheckinSubmitRequest request) {
        // éªŒè¯å±‚
        validator.validateCheckinQrCode(request.getToken());
        validator.validateActivityOngoing(...);
        
        // ä¸šåŠ¡å±‚
        return checkinService.submitCheckin(request);
    }
    
    // è¯„ä»·ä¸»æµç¨‹
    public EvaluationSubmitResponseVO submitEvaluation(EvaluationSubmitRequest request) {
        // éªŒè¯å±‚
        validator.validateEvaluationQrCode(request.getToken());
        validator.validateActivityEnded(...);
        
        // ä¸šåŠ¡å±‚
        return evaluationService.submitEvaluation(request);
    }
}

é¢„æœŸæ•ˆæœï¼š
- æ¸…æ™°çš„ä¸šåŠ¡æµç¨‹
- ç»Ÿä¸€çš„éªŒè¯ç­–ç•¥
- æ˜“äºæ·»åŠ æ¨ªåˆ‡å…³æ³¨ï¼ˆæ—¥å¿—ã€ç›‘æ§ã€æ€§èƒ½ç»Ÿè®¡ï¼‰
```

### 5.3 é•¿æœŸä¼˜åŒ–ï¼ˆé«˜é£é™©ï¼Œ1å¹´åï¼‰

#### 1ï¸âƒ£ CQRS æ¨¡å¼ï¼ˆæŸ¥è¯¢ä¸æ›´æ–°åˆ†ç¦»ï¼‰

```
ç›®æ ‡ï¼šä¼˜åŒ–å¤æ‚çš„ç»Ÿè®¡æŸ¥è¯¢

å½“å‰é—®é¢˜ï¼š
- ç»Ÿè®¡æ•°æ®æŸ¥è¯¢è·¨å¤šä¸ªè¡¨å’Œæ¨¡å—
- å®æ—¶ç»Ÿè®¡æ€§èƒ½ä¸ä½³

è§£å†³æ–¹æ¡ˆï¼š
- æŸ¥è¯¢ï¼šåŸºäºä¸“ç”¨çš„ç»Ÿè®¡è¡¨æˆ–è§†å›¾ï¼ˆåªè¯»å‰¯æœ¬ï¼‰
- æ›´æ–°ï¼šé€šè¿‡äº‹ä»¶å¼‚æ­¥æ›´æ–°ç»Ÿè®¡æ•°æ®

é¢„æœŸæ•ˆæœï¼š
- ç»Ÿè®¡æŸ¥è¯¢æ€§èƒ½æå‡ 5-10 å€
- æ˜“äºæ‰©å±•å¤æ‚çš„æŠ¥è¡¨åŠŸèƒ½
```

---

## å…­ã€æ€»ä½“è®¾è®¡è¯„åˆ†

### 6.1 å„æ¨¡å—è¯„åˆ†

| æ¨¡å— | è®¾è®¡åˆç†æ€§ | ä»£ç è´¨é‡ | å¯ç»´æŠ¤æ€§ | å¯æ‰©å±•æ€§ | æ€»ä½“è¯„åˆ† |
|------|----------|--------|--------|--------|---------|
| QrCode | 8/10 | 8/10 | 9/10 | 8/10 | âœ… **8.3/10** |
| Activity | 6/10 | 7/10 | 6/10 | 6/10 | âš ï¸ **6.3/10** |
| Checkin | 6/10 | 6/10 | 5/10 | 5/10 | âš ï¸ **5.5/10** |
| Evaluation | 6/10 | 6/10 | 5/10 | 5/10 | âš ï¸ **5.5/10** |

### 6.2 ç»¼åˆè¯„ä»·

**ç°çŠ¶ï¼š**
- âœ… æ•´ä½“æ¶æ„æ¸…æ™°ï¼Œç¬¦åˆå¾®æœåŠ¡æ€æƒ³
- âœ… æ¨¡å—åˆ’åˆ†åˆç†ï¼Œå„å¸å…¶èŒ
- âš ï¸ éªŒè¯é€»è¾‘é‡å¤ç‡é«˜ï¼ˆ70%+ï¼‰
- âš ï¸ è·¨æ¨¡å—ä¾èµ–å…³ç³»å¤æ‚
- âš ï¸ å­˜åœ¨èŒè´£è •å˜ç°è±¡

**å»ºè®®ï¼š**
1. **ç«‹å³å®æ–½** - ä¼˜åŒ–éªŒè¯é€»è¾‘ï¼ˆå·¥ä½œé‡ï¼š2-3å¤©ï¼‰
2. **é€æ­¥æ¨è¿›** - äº‹ä»¶é©±åŠ¨è§£è€¦ï¼ˆå·¥ä½œé‡ï¼š1-2å‘¨ï¼‰
3. **åç»­è€ƒè™‘** - CQRS æ¨¡å¼ä¼˜åŒ–ç»Ÿè®¡ï¼ˆå·¥ä½œé‡ï¼š2-4å‘¨ï¼‰

---

## ä¸ƒã€åŠŸèƒ½æµç¨‹å›¾å¯¹æ¯”

### 7.1 æ‰“å¡æµç¨‹ï¼ˆå½“å‰ï¼‰

```
å‚ä¸è€…æ‰«ç 
    â†“
è¯·æ±‚: GET /api/qrcodes/verify?token=xxx
    â†“
QrCodeService.verifyQrCode()
    â”œâ”€ éªŒè¯JWTç­¾å âœ“
    â”œâ”€ æ£€æŸ¥è¿‡æœŸæ—¶é—´ âœ“
    â””â”€ æ£€æŸ¥çŠ¶æ€ âœ“
    â†“
è¯·æ±‚: POST /api/checkins/submit
    â”œâ”€ RequestBody: {token, teachingPointId, attendeeCount}
    â†“
CheckinServiceImpl.submitCheckin()
    â”œâ”€ éªŒè¯äºŒç»´ç  (å†æ¬¡) âŒ å†—ä½™
    â”œâ”€ æ£€æŸ¥äºŒç»´ç ç±»å‹
    â”œâ”€ éªŒè¯æ´»åŠ¨å­˜åœ¨
    â”œâ”€ æ£€æŸ¥æ´»åŠ¨çŠ¶æ€ (3å±‚æ£€æŸ¥) 
    â”œâ”€ æ£€æŸ¥å¹‚ç­‰æ€§
    â””â”€ æ’å…¥æ‰“å¡è®°å½•
    â†“
è¿”å›: CheckinSubmitResponseVO
```

### 7.2 æ‰“å¡æµç¨‹ï¼ˆä¼˜åŒ–åï¼‰

```
å‚ä¸è€…æ‰«ç 
    â†“
è¯·æ±‚: POST /api/checkins/submit (åŒ…å«token)
    â†“
ParticipationOrchestrator.submitCheckin()
    â”œâ”€ validator.validateCheckinQrCode(token)
    â”‚   â”œâ”€ QrCodeService.verifyQrCodeOfType(token, CHECKIN)
    â”‚   â”œâ”€ éªŒè¯JWTç­¾å âœ“
    â”‚   â”œâ”€ æ£€æŸ¥è¿‡æœŸæ—¶é—´ âœ“
    â”‚   â””â”€ æ£€æŸ¥ç±»å‹å’ŒçŠ¶æ€ âœ“
    â”‚
    â”œâ”€ validator.validateActivityOngoing(activityId)
    â”‚   â”œâ”€ éªŒè¯æ´»åŠ¨å­˜åœ¨
    â”‚   â”œâ”€ æ£€æŸ¥çŠ¶æ€å’Œæ—¶é—´
    â”‚   â””â”€ è¿”å›æ´»åŠ¨å¯¹è±¡
    â”‚
    â”œâ”€ validator.validateCheckinIdempotent(...)
    â”‚   â””â”€ æ£€æŸ¥æ˜¯å¦å·²æ‰“å¡
    â”‚
    â””â”€ CheckinService.submitCheckin()
        â””â”€ æ’å…¥æ‰“å¡è®°å½•
    â†“
è¿”å›: CheckinSubmitResponseVO
```

**æ”¹è¿›å¯¹æ¯”ï¼š**
- âœ… éªŒè¯é€»è¾‘æ¸…æ™°åˆ†å±‚
- âœ… æ¶ˆé™¤å†—ä½™éªŒè¯
- âœ… ä¸šåŠ¡æµç¨‹ä¸€ç›®äº†ç„¶
- âœ… æ˜“äºå•å…ƒæµ‹è¯•

---

## å…«ã€ç»“è®ºä¸å»ºè®®

### 8.1 æ ¸å¿ƒç»“è®º

| ç»´åº¦ | ç»“è®º | å»ºè®® |
|------|------|------|
| **æ¶æ„åˆç†æ€§** | åŸºæœ¬åˆç†ï¼Œæ¨¡å—åˆ’åˆ†æ¸…æ™° | åŠ å¼ºäº‹ä»¶é©±åŠ¨è®¾è®¡ |
| **åŠŸèƒ½å†—ä½™** | å­˜åœ¨ 70%+ éªŒè¯é€»è¾‘é‡å¤ | æå–éªŒè¯å™¨æ¶ˆé™¤å†—ä½™ |
| **èŒè´£æ¸…æ™°åº¦** | å¤§éƒ¨åˆ†æ¨¡å—ç¬¦åˆ SRPï¼ŒActivity æœ‰è •å˜ | ä½¿ç”¨äº‹ä»¶é©±åŠ¨è§£è€¦ |
| **ä»£ç è´¨é‡** | å¯è¯»æ€§ä¸­ç­‰ï¼Œæ”¹è¿›ç©ºé—´å¤§ | æå–éªŒè¯å™¨+ç®€åŒ–æµç¨‹ |

### 8.2 ä¼˜å…ˆçº§å»ºè®®

#### ğŸ”´ ç«‹å³ä¿®å¤ï¼ˆå½±å“è¿è¡Œï¼‰
- æ— ä¸¥é‡è®¾è®¡ç¼ºé™·

#### ğŸŸ¡ è¿‘æœŸä¼˜åŒ–ï¼ˆ3ä¸ªæœˆå†…ï¼Œå½±å“å¯ç»´æŠ¤æ€§ï¼‰
1. æå–éªŒè¯å™¨æ¶ˆé™¤å†—ä½™ï¼ˆ**P1 - 2-3å¤©**ï¼‰
2. ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼ˆ**P2 - 1å¤©**ï¼‰
3. å¢å¼º QrCodeService æ¥å£ï¼ˆ**P2 - 1å¤©**ï¼‰

#### ğŸŸ¢ ä¸­æœŸä¼˜åŒ–ï¼ˆ6ä¸ªæœˆå†…ï¼Œæå‡æ¶æ„ï¼‰
1. å®æ–½äº‹ä»¶é©±åŠ¨è§£è€¦ï¼ˆ**P3 - 1-2å‘¨**ï¼‰
2. åˆ›å»ºå‚ä¸æµç¨‹åè°ƒå™¨ï¼ˆ**P3 - 1å‘¨**ï¼‰

#### ğŸ”µ åæœŸä¼˜åŒ–ï¼ˆ1å¹´åï¼Œæ€§èƒ½ä¼˜åŒ–ï¼‰
1. CQRS æ¨¡å¼ä¼˜åŒ–ç»Ÿè®¡ï¼ˆ**P4 - 2-4å‘¨**ï¼‰

### 8.3 æœ€ç»ˆå»ºè®®

âœ… **ç³»ç»Ÿæ•´ä½“è®¾è®¡åˆç†**ï¼Œç¬¦åˆå¾®æœåŠ¡æ¶æ„æ€æƒ³

âš ï¸ **å­˜åœ¨ä¼˜åŒ–ç©ºé—´**ï¼Œä¸»è¦åœ¨ä»£ç å¤ç”¨å’Œè€¦åˆæ–¹é¢

âœ… **å»ºè®®æŒ‰ä¼˜å…ˆçº§é€æ­¥æ”¹è¿›**ï¼Œä¸éœ€è¦å¤§è§„æ¨¡é‡æ„

---

## é™„å½•ï¼šä»£ç ç¤ºä¾‹å¯¹æ¯”

### A.1 éªŒè¯å™¨æå–ç¤ºä¾‹

**æå–å‰ï¼š** 120+ è¡Œåˆ†æ•£åœ¨å„æ¨¡å—
**æå–åï¼š** 40 è¡Œé›†ä¸­ç®¡ç†
**ä»£ç å¤ç”¨ç‡æå‡ï¼š** ä» 0% â†’ 70%

### A.2 äº‹ä»¶é©±åŠ¨ç¤ºä¾‹

```java
// å‘å¸ƒäº‹ä»¶ï¼ˆActivity æ¨¡å—ï¼‰
@Transactional
public Long createActivity(...) {
    Activity activity = new Activity();
    // ... è®¾ç½®å±æ€§ ...
    activityMapper.insert(activity);
    
    // å‘å¸ƒäº‹ä»¶
    eventPublisher.publishEvent(
        new ActivityCreatedEvent(this, activity)
    );
    
    return activity.getId();
}

// ç›‘å¬äº‹ä»¶ï¼ˆQrCode æ¨¡å—ï¼‰
@EventListener
@Transactional
public void handleActivityCreated(ActivityCreatedEvent event) {
    Activity activity = event.getActivity();
    
    try {
        // ç”Ÿæˆæ‰“å¡äºŒç»´ç 
        generateQrCode(activity.getId(), QrCodeTypeEnum.CHECKIN);
        // ç”Ÿæˆè¯„ä»·äºŒç»´ç 
        generateQrCode(activity.getId(), QrCodeTypeEnum.EVALUATION);
    } catch (Exception e) {
        log.error("äºŒç»´ç ç”Ÿæˆå¤±è´¥", e);
        // å¯é€‰ï¼šå‘å¸ƒå¤±è´¥äº‹ä»¶ä¾›ç›‘å¬å¤„ç†
    }
}
```

---

**æŠ¥å‘Šç»“æŸ**  
**ç‰ˆæœ¬ï¼š** v1.0  
**æ—¥æœŸï¼š** 2024-10-31  
**ä½œè€…ï¼š** ç³»ç»Ÿæ¶æ„åˆ†æ



# 系统数据初始化说明

**功能：** 系统基础数据自动初始化  
**版本：** v1.2.0  
**日期：** 2025-11-01  
**状态：** ✅ **已实现**  

---

## 📋 功能概述

本功能实现了系统启动时的基础数据自动初始化，包括：

1. **县域数据**：崇左市各县（市、区）数据初始化
2. **管理员账号**：系统内置市级管理员账号初始化
3. **数据库脚本**：提供SQL脚本用于手动初始化
4. **智能更新**：支持增量更新，避免重复插入

---

## 🌍 崇左市县域数据

| 县域代码（邮政编码） | 县域名称 | 状态 |
|-------------------|---------|------|
| 532200 | 江州区 | enabled |
| 532100 | 扶绥县 | enabled |
| 532500 | 宁明县 | enabled |
| 532400 | 龙州县 | enabled |
| 532300 | 大新县 | enabled |
| 532800 | 天等县 | enabled |
| 532600 | 凭祥市 | enabled |

**说明：**
- 县域代码使用邮政编码作为唯一标识
- 所有县域初始状态为 `enabled`（启用）
- 数据来源：崇左市官方行政区划及邮政编码

---

## 🚀 实现方式

### 方式一：数据库脚本（手动初始化）

**脚本位置：** `sql/init_counties_chongzuo.sql`

**使用方法：**

```bash
# 进入MySQL
mysql -u root -p we_chat_checkin_dev

# 执行初始化脚本
source /path/to/sql/init_counties_chongzuo.sql;
```

**脚本特性：**
- ✅ 使用 `ON DUPLICATE KEY UPDATE` 避免重复插入
- ✅ 自动更新现有数据
- ✅ 附带验证查询

### 方式二：应用启动初始化（自动）⭐ 推荐

**实现类：** `com.wechat.checkin.common.service.DataInitService`

**工作原理：**

```java
@Service
@Order(1)  // 确保优先执行
public class DataInitService implements CommandLineRunner {
    
    @Override
    public void run(String... args) throws Exception {
        // 1. 初始化县域数据
        initCounties();
        
        // 2. 初始化管理员账号
        initAdminUser();
    }
}
```

**执行时机：** Spring Boot 应用启动时自动执行

**日志输出：**

```
==================================================
开始执行系统数据初始化...
==================================================
【1/2】开始初始化县域数据...
  ✓ 新增县域: 532200 - 江州区
  ✓ 新增县域: 532100 - 扶绥县
  ✓ 新增县域: 532500 - 宁明县
  ✓ 新增县域: 532400 - 龙州县
  ✓ 新增县域: 532300 - 大新县
  ✓ 新增县域: 532800 - 天等县
  ✓ 新增县域: 532600 - 凭祥市
  县域数据初始化完成 - 新增: 7 条, 更新: 0 条, 跳过: 0 条
  当前系统中的县域列表 (共7个):
【2/2】开始初始化管理员账号...
  ✓ 成功创建市级管理员账号: admin (密码: admin123)
==================================================
系统数据初始化完成
==================================================
```

---

## 🎯 数据初始化服务特性

### 1. 统一管理

- ✅ 所有基础数据初始化集中在 `DataInitService` 中
- ✅ 使用 `@Order(1)` 确保优先执行
- ✅ 支持多种数据类型的初始化

### 2. 智能检测

- ✅ 自动检测数据库表是否存在
- ✅ 如果表不存在，跳过对应的初始化（避免启动失败）
- ✅ 检查数据是否已存在

### 3. 增量更新

- ✅ 已存在的数据不重复插入
- ✅ 如果数据变更，自动更新
- ✅ 保持数据一致性

### 4. 详细日志

- ✅ 按步骤显示初始化进度（【1/2】【2/2】）
- ✅ 记录每个数据的处理结果（新增/更新/跳过）
- ✅ 统计总体执行结果

### 5. 错误处理

- ✅ 单个数据处理失败不影响其他数据
- ✅ 记录错误日志便于排查
- ✅ 保证应用正常启动

---

## 📂 相关文件

### 1. SQL脚本

```
sql/init_counties_chongzuo.sql
```

手动初始化脚本，包含崇左市7个县域的INSERT语句。

### 2. 数据初始化服务

```
backend/we-chat-common/src/main/java/com/wechat/checkin/common/service/
└── DataInitService.java
```

统一的数据初始化服务，实现 `CommandLineRunner` 接口，包含：
- `initCounties()` - 县域数据初始化
- `initAdminUser()` - 管理员账号初始化
- `resetAdminPassword()` - 密码重置（开发测试用）

### 3. 数据库表

```sql
CREATE TABLE `counties` (
  `code` VARCHAR(16) NOT NULL COMMENT '县域编码',
  `name` VARCHAR(64) NOT NULL COMMENT '县域名称',
  `status` ENUM('enabled', 'disabled', 'deleted') NOT NULL DEFAULT 'enabled',
  `created_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`code`),
  INDEX `idx_counties_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 🔧 使用方法

### 首次部署

1. **确保数据库表已创建**

   ```bash
   # 执行建表脚本
   mysql -u root -p we_chat_checkin_dev < sql/create_tables.sql
   ```

2. **启动应用**

   ```bash
   cd backend/we-chat-web
   mvn spring-boot:run
   ```

3. **观察日志**

   启动时会自动执行县域数据初始化，并输出详细日志。

### 后续更新

#### 添加新的县域

如果需要添加新的县域或修改现有县域：

1. **修改数据初始化服务**

   编辑 `DataInitService.java`，更新 `CHONGZUO_COUNTIES` Map。

2. **重启应用**

   初始化器会自动检测变更并更新数据。

3. **手动执行SQL（可选）**

   也可以直接在数据库中执行 INSERT/UPDATE 语句。

#### 添加新的初始化数据

如果需要添加其他类型的基础数据：

1. **在 DataInitService 中添加新方法**

   ```java
   @Transactional
   public void initYourData() {
       log.info("【X/Y】开始初始化您的数据...");
       // 实现初始化逻辑
   }
   ```

2. **在 run() 方法中调用**

   ```java
   @Override
   public void run(String... args) throws Exception {
       initCounties();
       initAdminUser();
       initYourData();  // 添加新的初始化
   }
   ```

---

## ⚠️ 注意事项

### 1. 县域代码唯一性

- ✅ 县域代码（`code`）是主键，必须唯一
- ✅ 使用邮政编码作为县域代码
- ⚠️ 不要重复插入相同代码的县域

### 2. 外键约束

崇左市各县域数据被以下表引用：

- `admins` 表：县级管理员的 `county_code` 字段
- `teaching_points` 表：教学点的 `county_code` 字段
- `activities` 表：活动的 `scope_county_code` 字段

**影响：**
- ⚠️ 删除县域前，必须先删除或迁移相关的管理员、教学点、活动数据
- ⚠️ 建议使用软删除（设置 `status = 'deleted'`）而非物理删除

### 3. 数据库连接

- ✅ 确保应用能正常连接数据库
- ✅ 检查 `application-dev.yml` 中的数据库配置
- ⚠️ 如果数据库连接失败，初始化器会记录错误但不影响应用启动

### 4. 初始化时机

- ✅ 初始化器在应用完全启动后执行
- ✅ 不会阻塞应用启动过程
- ℹ️ 如果需要在启动前初始化，可以使用 `@EventListener(ApplicationReadyEvent.class)`

---

## 🧪 测试验证

### 1. 验证数据是否初始化成功

```sql
-- 查询所有县域
SELECT * FROM counties ORDER BY code;

-- 应该看到7条记录
-- 532100 - 扶绥县
-- 532200 - 江州区
-- 532300 - 大新县
-- 532400 - 龙州县
-- 532500 - 宁明县
-- 532600 - 凭祥市
-- 532800 - 天等县
```

### 2. 验证外键约束

```sql
-- 创建县级管理员（应该成功）
INSERT INTO admins (username, password, role, county_code, status)
VALUES ('JZ_admin', '$2a$10$encrypted', 'county', '532200', 'enabled');

-- 使用不存在的县域代码（应该失败）
INSERT INTO admins (username, password, role, county_code, status)
VALUES ('XX_admin', '$2a$10$encrypted', 'county', '999999', 'enabled');
-- Error: Cannot add or update a child row: a foreign key constraint fails
```

### 3. 测试 API 接口

```bash
# 创建县级管理员
curl -X POST http://localhost:8080/api/admins \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "username": "JZ_admin",
    "password": "123456",
    "role": "county",
    "countyCode": "532200"
  }'
```

---

## 📊 统计与监控

### 1. 查询县域使用情况

```sql
-- 各县域的管理员数量
SELECT 
    c.code, 
    c.name, 
    COUNT(a.id) as admin_count
FROM counties c
LEFT JOIN admins a ON c.code = a.county_code AND a.status != 'deleted'
GROUP BY c.code, c.name
ORDER BY c.code;

-- 各县域的教学点数量
SELECT 
    c.code, 
    c.name, 
    COUNT(t.id) as teaching_point_count
FROM counties c
LEFT JOIN teaching_points t ON c.code = t.county_code AND t.status != 'deleted'
GROUP BY c.code, c.name
ORDER BY c.code;

-- 各县域的活动数量
SELECT 
    c.code, 
    c.name, 
    COUNT(a.id) as activity_count
FROM counties c
LEFT JOIN activities a ON c.code = a.scope_county_code AND a.status != 'deleted'
GROUP BY c.code, c.name
ORDER BY c.code;
```

### 2. 监控初始化日志

- ✅ 启动日志中查看初始化结果
- ✅ 检查是否有错误或警告信息
- ✅ 验证新增/更新/跳过的数量是否符合预期

---

## 🎓 扩展建议

### 1. 支持多城市

如果需要支持多个城市，可以扩展为：

```java
private static final Map<String, Map<String, String>> CITIES = Map.of(
    "崇左市", CHONGZUO_COUNTIES,
    "南宁市", NANNING_COUNTIES,
    // ... 更多城市
);
```

### 2. 配置化管理

将县域数据移至配置文件：

```yaml
# application.yml
counties:
  chongzuo:
    - code: "532200"
      name: "江州区"
    - code: "532100"
      name: "扶绥县"
    # ...
```

### 3. 数据库迁移工具

集成 Flyway 或 Liquibase 进行数据库版本管理：

```xml
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
```

---

## 🔄 内置数据说明

### 1. 县域数据

- **数量**：7个县（市、区）
- **来源**：崇左市行政区划及邮政编码
- **状态**：全部启用（enabled）

### 2. 管理员账号

- **账号**：admin
- **密码**：admin123
- **角色**：市级管理员（city）
- **用途**：系统初始登录账号

⚠️ **安全提示**：首次登录后请立即修改默认密码！

---

## ✨ 总结

本功能实现了系统基础数据的统一自动化初始化，具有以下优势：

1. **统一管理**：所有初始化逻辑集中在 `DataInitService` 中
2. **自动化**：应用启动时自动执行，无需手动干预
3. **智能化**：自动检测并处理新增、更新、跳过场景
4. **安全性**：错误处理完善，不影响应用启动
5. **可维护**：代码结构清晰，易于扩展和修改
6. **可追溯**：详细的日志记录，便于问题排查

现在您可以放心地启动应用，系统会自动完成以下初始化：
- ✅ 崇左市7个县域数据
- ✅ 系统管理员账号（admin/admin123）


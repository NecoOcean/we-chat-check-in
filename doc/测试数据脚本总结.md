# 测试数据脚本总结

**脚本名称：** `test_county_statistics_data.sql`  
**创建日期：** 2024-10-31  
**脚本大小：** ~700行  
**用途：** 测试市级管理员县域打卡统计功能  
**位置：** `sql/test_county_statistics_data.sql`  

---

## 📋 脚本内容概览

### 包含的8个部分

```
第1部分 → 县域数据 (3个县域)
第2部分 → 管理员账号 (3个县级账号，市级由系统生成)
第3部分 → 教学点数据 (15个教学点)
第4部分 → 获取市级管理员ID (从系统已有账户查询)
第5部分 → 活动数据 (1个活动)
第6部分 → 二维码数据 (2个二维码)
第7部分 → 打卡数据 (15条打卡记录)
第8部分 → 评价数据 (15条评价记录)
第9部分 → 数据验证 (6个验证查询)
```

### 数据统计

| 类别 | 数量 | 详情 |
|------|------|------|
| **县域** | 3 | 朝阳区(001)、丰台区(002)、东城区(003) |
| **教学点** | 15 | 每个县5个 |
| **活动** | 1 | 2024年秋季教学活动 (ONGOING) |
| **打卡记录** | 15 | 总参与人数420人 |
| **评价记录** | 15 | 满意度评分数据 |
| **二维码** | 2 | 打卡二维码+评价二维码 |
| **市级管理员** | 系统已有 | 由系统自动生成，脚本无需插入 |
| **县级管理员** | 3 | chaoyang_admin + fengtai_admin + dongcheng_admin |
| **总数据行** | >80 | 足以进行完整的功能测试 |

---

## 🚀 快速使用

### 一键导入

```bash
# 方法1: 命令行导入
mysql -u root -p wechat_checkin < sql/test_county_statistics_data.sql

# 方法2: MySQL中执行
mysql -u root -p
> USE wechat_checkin;
> SOURCE sql/test_county_statistics_data.sql;

# 方法3: Navicat/SQLyog/DBeaver图形界面
# 打开文件→选择数据库→执行
```

### 导入验证

脚本执行后，应看到 **5个验证查询的输出**：

```
✅ 活动信息表
✅ 县域打卡统计
✅ 打卡详情列表  
✅ 评价统计
✅ 管理员账号
```

---

## 🔐 内置测试账号

**密码统一为：** `admin123`

### 市级管理员
```
说明: 由系统自动生成，无需手动创建
使用现有的系统市级管理员账户，例如:
  用户名: admin (具体用户名请根据系统实际情况查看)
  角色: city
  县域: NULL (覆盖全市)
```

### 县级管理员 - 朝阳区
```sql
用户名: chaoyang_admin
密码: admin123
角色: county
县域: 001 (朝阳区)
```

### 县级管理员 - 丰台区
```sql
用户名: fengtai_admin
角色: county
县域: 002 (丰台区)
```

### 县级管理员 - 东城区
```sql
用户名: dongcheng_admin
角色: county
县域: 003 (东城区)
```

---

## 📊 测试场景

### 场景1: 市级管理员查看全部县域统计

**使用方法：**
- 使用系统中现有的市级管理员账户登录（例如: admin）
- 获取有效的JWT token

**预期结果：**
- ✅ `countyStatistics` 包含3个县域的统计
- ✅ `checkinDetails` 包含全部15条打卡记录
- ✅ 总参与人数: 420人 (30+28+32+26+34+25+29+31+27+33+24+22+28+26+30)

**县域统计明细：**
```
朝阳区(001): 教学点5个, 参与人数150, 打卡15条
丰台区(002): 教学点5个, 参与人数145, 打卡15条  
东城区(003): 教学点5个, 参与人数125, 打卡15条
```

### 场景2: 县级管理员只看本县数据

**预期结果：**
- ✅ `countyStatistics` = null (权限隐藏)
- ✅ `checkinDetails` 仅包含5条本县打卡记录

**示例 - 朝阳区管理员：**
```
看到的教学点:
  - 朝阳区第一小学 (30人)
  - 朝阳区第二中学 (28人)
  - 朝阳区第三高中 (32人)
  - 朝阳区第四初中 (26人)
  - 朝阳区第五小学 (34人)
  
看不到的数据:
  - 丰台区任何信息 ❌
  - 东城区任何信息 ❌
  - 其他县的统计 ❌
```

### 场景3: 权限隔离验证

| 功能 | 市级管理员 | 县级管理员 |
|------|-----------|----------|
| 查看 countyStatistics | ✅ 完整 | ❌ null |
| 查看本县 checkinDetails | ✅ 全部 | ✅ 本县 |
| 查看其他县 checkinDetails | ✅ 全部 | ❌ 无 |

---

## 🧪 具体测试步骤

### 第1步: 导入数据

```sql
mysql -u root -p wechat_checkin < sql/test_county_statistics_data.sql
```

**检查导入是否成功：**
```sql
-- 应该看到3个县级管理员账号
SELECT COUNT(*) FROM admins WHERE username IN ('chaoyang_admin', 'fengtai_admin', 'dongcheng_admin');
-- 结果: 3

-- 应该看到系统中至少有1个市级管理员
SELECT COUNT(*) FROM admins WHERE role = 'city';
-- 结果: ≥1

-- 应该看到3个县域
SELECT COUNT(*) FROM counties;
-- 结果: 3

-- 应该看到15个教学点
SELECT COUNT(*) FROM teaching_points;
-- 结果: 15

-- 应该看到1个活动
SELECT COUNT(*) FROM activities WHERE name = '2024年秋季教学活动';
-- 结果: 1

-- 应该看到15条打卡记录
SELECT COUNT(*) FROM checkins;
-- 结果: 15
```

### 第2步: 启动应用

```bash
cd backend/we-chat-web
mvn spring-boot:run
# 或
java -jar target/we-chat-web-1.0.0.jar
```

### 第3步: 登录获取Token

**系统市级管理员登录：**
```bash
# 使用系统中现有的市级管理员账户
curl -X POST "http://localhost:8080/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",  # 请替换为实际的市级管理员账户
    "password": "admin123"  # 请使用正确的密码
  }'

# 记录返回的 token
```

**县级管理员登录（朝阳区）：**
```bash
curl -X POST "http://localhost:8080/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "chaoyang_admin",
    "password": "admin123"
  }'
```

### 第4步: 查询活动ID

```bash
# 从数据库查询或通过API获取
curl -X GET "http://localhost:8080/api/activities?status=ongoing" \
  -H "Authorization: Bearer {token}"
  
# 记录返回的活动ID，例如: 1
```

### 第5步: 调用县域统计接口

```bash
# 市级管理员调用
curl -X GET "http://localhost:8080/api/activities/1/county-statistics" \
  -H "Authorization: Bearer {city_admin_token}" \
  -H "Content-Type: application/json"

# 预期返回:
# - countyStatistics: [朝阳区, 丰台区, 东城区] ✅
# - checkinDetails: 15条记录 ✅
```

---

## 🔍 SQL查询验证

### 验证县域统计逻辑

```sql
-- 查看数据库中的县域统计结果
SELECT 
    COALESCE(tp.county_code, 'UNKNOWN') as county_code,
    (SELECT name FROM counties WHERE code = tp.county_code) as county_name,
    COUNT(DISTINCT c.teaching_point_id) as participating_points,
    COALESCE(SUM(c.attendee_count), 0) as total_attendees,
    COUNT(*) as total_checkins
FROM checkins c
LEFT JOIN teaching_points tp ON c.teaching_point_id = tp.id
GROUP BY tp.county_code
ORDER BY tp.county_code;

-- 预期结果:
-- county_code | county_name | participating_points | total_attendees | total_checkins
-- 001         | 朝阳区      | 5                    | 150            | 5
-- 002         | 丰台区      | 5                    | 145            | 5
-- 003         | 东城区      | 5                    | 125            | 5
```

### 验证打卡详情逻辑

```sql
-- 查看所有打卡详情
SELECT 
    c.id,
    tp.name as teaching_point_name,
    tp.county_code,
    c.attendee_count,
    c.submitted_time
FROM checkins c
LEFT JOIN teaching_points tp ON c.teaching_point_id = tp.id
ORDER BY tp.county_code, c.submitted_time DESC;

-- 应该看到15行记录，按县域分组排列
```

### 验证权限隔离

```sql
-- 市级管理员: 可以看到全部数据
-- 县级管理员: 应该只能看到自己县的数据

-- 模拟县级管理员(朝阳区)的权限隔离:
SELECT 
    c.id,
    tp.name,
    tp.county_code
FROM checkins c
LEFT JOIN teaching_points tp ON c.teaching_point_id = tp.id
WHERE tp.county_code = '001'  -- 朝阳区
ORDER BY c.submitted_time;

-- 应该看到5行记录，全部是朝阳区的
```

---

## 📈 性能基准测试

### 测试命令

```bash
# 使用 Apache Bench 进行性能测试
ab -c 10 -n 100 \
  -H "Authorization: Bearer {token}" \
  "http://localhost:8080/api/activities/1/county-statistics"
```

### 预期结果

| 指标 | 预期 | 说明 |
|------|------|------|
| 平均响应时间 | < 100ms | 数据库查询速度快 |
| Min Time | < 50ms | 最快响应 |
| Max Time | < 300ms | 最慢响应 |
| 成功率 | 100% | 无错误 |
| 吞吐量 | > 50 req/s | 性能良好 |

---

## ✅ 验收检查清单

### 导入验证
- [ ] 脚本成功执行，无SQL错误
- [ ] 所有验证查询都返回数据
- [ ] 数据总数符合预期
- [ ] 市级管理员已存在（由系统自动生成）
- [ ] 3个县级管理员已创建

### 账号验证
- [ ] 系统中存在市级管理员 (role = 'city')
- [ ] chaoyang_admin 账户已创建
- [ ] fengtai_admin 账户已创建
- [ ] dongcheng_admin 账户已创建
- [ ] 所有账户密码为 admin123

### 功能验证
- [ ] 市级管理员可查看3个县域统计
- [ ] 县级管理员看不到 countyStatistics
- [ ] 打卡详情包含所有15条记录
- [ ] 数据按县域正确分组

### 权限验证
- [ ] city_admin 登录成功
- [ ] chaoyang_admin 登录成功
- [ ] 市级可查看全部数据
- [ ] 县级只能查看本县数据

### 字段验证
- [ ] countyCode 正确 (001, 002, 003)
- [ ] countyName 正确 (朝阳区、丰台区、东城区)
- [ ] participatingPoints 正确 (每个县5个)
- [ ] totalAttendees 正确 (150, 145, 125)
- [ ] totalCheckins 正确 (5, 5, 5)

### 性能验证
- [ ] 单个请求 < 100ms
- [ ] 并发测试成功率 100%
- [ ] 无数据库锁问题
- [ ] 无内存泄漏

---

## 🛠️ 故障排除

### 问题1: 脚本执行失败 - 市级管理员ID为NULL

**错误信息：** `Cannot execute query: NULL value for created_id`

**原因：** 系统中不存在市级管理员账户

**解决方案：**
```sql
-- 方案1: 首先检查系统中是否有市级管理员
SELECT * FROM admins WHERE role = 'city';

-- 方案2: 如果没有，可以创建一个测试用市级管理员
INSERT INTO admins (username, password, role, status) 
VALUES ('test_city_admin', 'hashed_password', 'city', 'enabled');

-- 方案3: 或手动修改脚本中的市级管理员ID
-- 在第4部分将这一行：
-- SELECT @city_admin_id := id FROM `admins` WHERE `role` = 'city' LIMIT 1;
-- 改为：
SET @city_admin_id := 1;  -- 替换为实际的市级管理员ID
```

### 问题2: 数据不完整 - 缺少县级管理员

**检查：**
```sql
SELECT username, role, county_code FROM admins 
WHERE username IN ('chaoyang_admin', 'fengtai_admin', 'dongcheng_admin');
```

如果缺少某个账户，可以手动重新插入：
```sql
INSERT INTO `admins` (`username`, `password`, `role`, `county_code`, `status`) VALUES
('chaoyang_admin', '$2a$10$N.zmdr9k7uOCQb0bMs/OdOUBqvCD2XGb67f8UjvMUfQH.q/pzUzem', 'county', '001', 'enabled');
```

### 问题3: 权限隔离不生效

**检查代码中的权限判断：**
```java
if ("city".equals(adminRole)) {
    countyStatistics = buildCountyCheckinStatistics(activityId);
} 
// 否则 countyStatistics = null
```

---

## 📚 相关文档

- 📄 [测试数据使用指南](./测试数据使用指南.md) - 详细的测试步骤
- 📄 [方案1实现完成总结](./方案1实现完成总结-县域统计需求.md) - API文档
- 📄 [方案1实现快速集成指南](./方案1实现快速集成指南.md) - 集成步骤

---

## 💡 使用建议

### 何时使用此脚本

- ✅ 功能开发完成后进行集成测试
- ✅ 性能基准测试和优化
- ✅ 权限隔离验证
- ✅ 演示给产品经理或需求方
- ✅ 新人快速了解系统

### 何时更新数据

- 需要更大的数据量时（增加更多县域、教学点）
- 需要测试特殊场景时（某些县没有打卡记录等）
- 进行压力测试时（生成数千条记录）

---

## 📝 脚本维护

### 如何扩展脚本

**添加更多教学点：**
```sql
-- 在第3部分添加
INSERT INTO `teaching_points` (`name`, `county_code`, `status`, `created_time`, `updated_time`) VALUES
('新教学点名称', '001', 'enabled', NOW(), NOW());
```

**添加更多打卡记录：**
```sql
-- 在第6部分添加
INSERT INTO `checkins` VALUES
(@activity_id, (SELECT id FROM teaching_points WHERE name = '...'), 50, NOW(), @checkin_qrcode_id);
```

**添加另一个活动：**
```sql
-- 创建第二个活动
INSERT INTO `activities` VALUES (...);
SELECT @activity_id_2 := LAST_INSERT_ID();

-- 为它创建二维码
INSERT INTO `qrcodes` VALUES (@activity_id_2, ...);

-- 添加打卡记录
INSERT INTO `checkins` VALUES (@activity_id_2, ...);
```

---

**脚本版本：** 1.0  
**最后更新：** 2024-10-31  
**维护状态：** ✅ 活跃维护

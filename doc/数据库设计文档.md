# 数据库设计（版本 5 对齐）

## 一、概览

- 选型建议：MySQL（或PostgreSQL）；使用InnoDB，开启外键约束与事务。
- 关键要求：权限隔离（县域）、二维码分阶段、幂等打卡、防重复评价、审计日志。

## 二、表结构

### admins（管理员账号）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | BIGINT PK | 管理员ID |
| username | VARCHAR(64) UNIQUE | 账号（如"PXadmin"） |
| password | VARCHAR(255) | 密码哈希 |
| role | ENUM('city','county') | 角色：市级/县级 |
| county_code | VARCHAR(16) NULL | 县域编码（县级必填，市级为空） |
| status | ENUM('enabled','disabled','deleted') | 状态：启用/禁用/软删除 |
| created_time | DATETIME | 创建时间 |
| updated_time | DATETIME | 更新时间 |

索引：`UNIQUE(username)`，`INDEX(role, county_code)`，`INDEX(status)`。
外键：`county_code` 引用 `counties.code`。

### counties（县域）
| 字段 | 类型 | 说明 |
|---|---|---|
| code | VARCHAR(16) PK | 县域编码 |
| name | VARCHAR(64) | 县域名称 |
| status | ENUM('enabled','disabled','deleted') | 状态：启用/禁用/软删除 |
| created_time | DATETIME | 创建时间 |
| updated_time | DATETIME | 更新时间 |

索引：`INDEX(status)`。

### teaching_points（教学点）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | BIGINT PK | 教学点ID |
| name | VARCHAR(128) | 教学点名称 |
| county_code | VARCHAR(16) FK counties.code | 归属县域 |
| status | ENUM('enabled','disabled','deleted') | 状态：启用/禁用/软删除 |
| created_time | DATETIME | 创建时间 |
| updated_time | DATETIME | 更新时间 |

索引：`INDEX(county_code, status)`，`INDEX(name)`。

### activities（活动）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | BIGINT PK | 活动ID |
| name | VARCHAR(128) | 活动名称 |
| description | TEXT NULL | 活动说明 |
| scope_county_code | VARCHAR(16) NULL | 县域范围（县级活动必填；市级活动为空时覆盖本市所有县域，指定时仅覆盖该县域） |
| start_time | DATETIME | 打卡开始时间 |
| end_time | DATETIME | 打卡结束时间 |
| ended_time | DATETIME NULL | 结束操作时间 |
| created_id | BIGINT FK admins.id | 发起管理员ID |
| status | ENUM('draft','ongoing','ended') | 活动状态：草稿/进行中/已结束 |
| created_time | DATETIME | 创建时间 |
| updated_time | DATETIME | 更新时间 |

索引：`INDEX(status, start_time, end_time)`，`INDEX(scope_county_code)`。
外键：`scope_county_code` 引用 `counties.code`，`created_id` 引用 `admins.id`。

### qrcodes（二维码）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | BIGINT PK | 二维码ID |
| activity_id | BIGINT FK activities.id | 关联活动 |
| type | ENUM('checkin','evaluation') | 类型：打卡/评价 |
| token | VARCHAR(128) UNIQUE | 二维码令牌（含签名信息） |
| expire_time | DATETIME NULL | 过期时间 |
| disabled_time | DATETIME NULL | 禁用时间 |
| status | ENUM('enabled','disabled','deleted') | 状态：启用/禁用/软删除 |
| created_time | DATETIME | 创建时间 |
| updated_time | DATETIME | 更新时间 |

索引：`UNIQUE(token)`，`INDEX(activity_id, type, status)`，`INDEX(expire_time)`。
外键：`activity_id` 引用 `activities.id`（级联删除）。

### checkins（打卡）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | BIGINT PK | 打卡ID |
| activity_id | BIGINT FK activities.id | 活动ID |
| teaching_point_id | BIGINT FK teaching_points.id | 教学点ID |
| attendee_count | INT | 实到人数 |
| submitted_time | DATETIME | 提交时间 |
| source_qrcode_id | BIGINT FK qrcodes.id | 来源二维码 |

约束：`UNIQUE(activity_id, teaching_point_id)`（幂等约束：同一活动同一教学点只能有一次打卡记录）。
索引：`INDEX(activity_id, submitted_time)`，`INDEX(teaching_point_id)`，`INDEX(source_qrcode_id)`。
外键：`activity_id` 引用 `activities.id`（级联删除），`teaching_point_id` 引用 `teaching_points.id`，`source_qrcode_id` 引用 `qrcodes.id`。

### evaluations（评价）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | BIGINT PK | 评价ID |
| activity_id | BIGINT FK activities.id | 活动ID |
| teaching_point_id | BIGINT FK teaching_points.id | 教学点ID |
| q1_satisfaction | TINYINT | 满意度（1-3） |
| q2_practicality | TINYINT | 实用性（1-3） |
| q3_quality | TINYINT NULL | 质量（1-3，可选） |
| suggestion_text | VARCHAR(200) NULL | 建议（≤200字） |
| submitted_time | DATETIME | 提交时间 |
| source_qrcode_id | BIGINT FK qrcodes.id | 来源二维码 |

约束：`UNIQUE(activity_id, teaching_point_id)`（防重复评价：同一活动同一教学点只能评价一次）；仅允许参与过活动的教学点写评价。
检查约束：`q1_satisfaction BETWEEN 1 AND 3`，`q2_practicality BETWEEN 1 AND 3`，`q3_quality IS NULL OR (q3_quality BETWEEN 1 AND 3)`。
索引：`INDEX(activity_id, submitted_time)`，`INDEX(teaching_point_id)`，`INDEX(source_qrcode_id)`。
外键：`activity_id` 引用 `activities.id`（级联删除），`teaching_point_id` 引用 `teaching_points.id`，`source_qrcode_id` 引用 `qrcodes.id`。

### audit_logs（审计日志）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | BIGINT PK | 日志ID |
| actor_admin_id | BIGINT FK admins.id | 操作者管理员 |
| action | VARCHAR(64) | 动作（create_admin、disable_qrcode、finish_activity等） |
| target_type | VARCHAR(64) | 目标类型（admin、activity、qrcode等） |
| target_id | BIGINT | 目标ID |
| before_json | JSON NULL | 变更前数据 |
| after_json | JSON NULL | 变更后数据 |
| created_time | DATETIME | 记录时间 |

索引：`INDEX(actor_admin_id, created_time)`，`INDEX(action)`，`INDEX(target_type, target_id)`。
外键：`actor_admin_id` 引用 `admins.id`。

## 三、设计要点

- 权限：所有查询与写入按角色与县域过滤；市级访问全量，县级限制本县。
- 二维码：token需签名与校验；生成时记录类型与有效期；禁用后状态更新为disabled。
- 幂等：打卡采用活动+教学点唯一约束；评价同样采用唯一约束防止重复。
- 统计：看板与详情依赖聚合查询，需加索引与适度缓存。
- 时间字段：统一使用 `_time` 后缀（created_time、updated_time、submitted_time等）。
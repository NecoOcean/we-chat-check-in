# 后端开发任务清单（版本 5 对齐）

## 一、范围与目标

- 范围：活动管理、用户与权限、二维码服务、参与提交（打卡/评价）、数据看板、审计日志、系统管理。
- 目标：满足“账号化管理 + 二维码轻参与 + 权限隔离 + 数据可视化 + 可审计”的完整后端能力。

## 二、优先级与里程碑

1. M1（基础能力）：认证与RBAC、活动CRUD、打卡二维码生成与校验、打卡提交接口、看板基础统计。
2. M2（管理完善）：县级账号管理（由市级）、二维码状态管理（禁用/有效期）、评价二维码与评价提交、活动结束流程。
3. M3（可靠与安全）：审计日志、幂等与防重、限流与风控、错误码与统一日志、缓存与索引优化。

## 三、详细任务清单

### 认证与权限（RBAC）
- 实现管理员登录（市级/县级），JWT或Session机制，支持密码策略与登录失败保护。
- 基于角色与县域的权限校验中间件：市级全量权限、县级限制本县数据访问。
- 获取当前用户信息与登出接口。

### 用户管理（市级）
- 县级账号创建、修改密码、启用/禁用、软删除；记录操作审计日志。
- 县级账号列表与详情查询；支持按状态与县域过滤。

### 活动管理
- 活动创建、更新、详情、列表（分页、按状态/县域过滤）。
- 活动结束操作：更新状态、使打卡二维码失效；记录审计日志。

### 教学点数据
- 教学点数据读接口（列表、按县域过滤）；如需变更由市级维护。

### 二维码服务
- 生成打卡二维码：包含活动ID与签名、有效期与状态；输出图片与深链。
- 生成评价二维码：仅活动结束后允许，默认有效期7天（可配置）。
- 二维码状态管理：查看、禁用、批量禁用；禁用后扫码提示失效。
- 二维码校验：服务端验证签名、有效期、状态与阶段（打卡/评价）。

### 打卡提交
- 无需登录，提交参数：二维码令牌/签名、教学点ID、实到人数。
- 校验：活动进行中、二维码未禁用且在有效期；人数为正整数；每教学点每活动仅保留一次最新提交（幂等覆盖）。
- 存储：写入出勤数据；更新活动详情聚合。

### 评价提交
- 仅活动结束后且该教学点参与过活动方可评价；参数含选择题项与≤200字建议。
- 校验二维码阶段与有效性；校验题目选项合法。
- 存储：写入评价数据；支持汇总统计（满意度分布等）。

### 数据看板与统计
- 平台总览：总活动数、进行中活动数、累计参与教学点数、累计参与人数。
- 活动详情统计：参与教学点列表与人数、评价汇总与明细；优化聚合查询与索引。
- 刷新策略：默认10分钟自动刷新；支持接口拉取实时数据。

### 审计与日志
- 审计日志：账号管理、活动结束、二维码生成/禁用等关键操作入库留痕。
- 系统日志：统一结构化日志、错误码与追踪ID；便于定位问题。

### 可靠性与安全
- 幂等与防重：基于教学点+活动唯一约束实现打卡幂等；评价重复提交拦截。
- 速率限制与风控：对打卡/评价接口做限流，异常IP隔离与告警。
- 二维码安全：签名与过期策略、防伪与防篡改；禁用后立即失效。

### 测试与交付
- 单元测试与集成测试覆盖核心模块；构建与CI流程。
- 环境配置与部署文档；错误码与接口对接说明。

## 四、技术栈与依赖

### 后端技术栈
- **框架**：Spring Boot 2.7+、Spring Security、Spring Data JPA
- **数据库**：MySQL 8.0+、HikariCP连接池
- **工具库**：Hutool（工具类）、MapStruct（对象映射）、Validation（参数校验）
- **二维码**：ZXing（二维码生成与解析）
- **文档**：Swagger3/Knife4j（API文档）
- **日志**：Logback + SLF4J
- **构建**：Maven 多模块管理

### SpringBoot 模块架构
```
we-chat-check-in/
├── we-chat-common/          # 公共模块（工具类、常量、异常定义）
├── we-chat-auth/            # 认证授权模块
├── we-chat-activity/        # 活动管理模块
├── we-chat-qrcode/          # 二维码管理模块
├── we-chat-participation/   # 参与打卡模块
├── we-chat-evaluation/      # 活动评价模块
├── we-chat-dashboard/       # 数据看板模块
├── we-chat-admin/           # 用户管理模块
├── we-chat-audit/           # 审计日志模块
└── we-chat-web/             # Web启动模块（Controller层）
```

### 数据存储策略
- **关系数据**：MySQL存储用户、活动、打卡、评价等核心业务数据
- **二维码图片**：Base64编码直接存储在数据库LONGTEXT字段中
- **统计数据**：通过数据库聚合查询实现，无需额外缓存层

## 五、验收标准（示例）

- 用县级账号无法访问其他县数据；市级账号可访问全量数据。
- 活动结束后打卡二维码扫码提示失效，评价二维码可生成并生效。
- 未参与教学点扫码评价提示“无参与记录，无法评价”。
- 看板数据在10分钟粒度内与明细数据一致，聚合性能达标。
# 数据库设计补充（版本 5 对齐）

## 一、数据约束与校验

- 打卡约束：`UNIQUE(activity_id, teaching_point_id)`，保证同一教学点同一活动仅保留一次打卡记录。
- 评价约束：`UNIQUE(activity_id, teaching_point_id)`，必须存在该教学点的打卡记录方可评价，防止重复评价。
- 二维码校验：需同时校验`type`（阶段）、`expire_time`与`status`；过期或禁用（disabled）或软删除（deleted）均不可用。

## 二、有效期与状态管理

- 打卡二维码：通常与活动进行期绑定；活动结束则置为失效（由服务端控制）。
- 评价二维码：默认有效期7天，可配置；过期后由业务判断处理。
- 禁用策略：禁用即刻生效，status设置为disabled；需记录`disabled_time`并写审计日志。
- 状态枚举：统一使用 enabled/disabled/deleted 三态。

## 三、幂等与防重策略

- 打卡：幂等键为`(activity_id, teaching_point_id)`；唯一约束防止重复提交。
- 评价：前端防重复提交 + 后端短期窗口限流；数据库层面通过`UNIQUE(activity_id, teaching_point_id)`防止重复评价。
- 提交令牌：可在二维码token中加入一次性nonce（可选）提升防重能力。

## 四、索引与性能优化

- 高频查询：活动详情页按`activity_id`聚合；看板按状态与时间范围大查询。
- 建议索引：
  - `activities`: `(status, start_time, end_time)`、`(scope_county_code)`
  - `checkins`: `(activity_id, submitted_time)`、`(teaching_point_id)`、`(source_qrcode_id)`
  - `evaluations`: `(activity_id, submitted_time)`、`(teaching_point_id)`、`(source_qrcode_id)`
  - `qrcodes`: `(activity_id, type, status)`、`(expire_time)`
  - `admins`: `(role, county_code)`、`(status)`
  - `teaching_points`: `(county_code, status)`
  - `audit_logs`: `(actor_admin_id, created_time)`、`(target_type, target_id)`
- 缓存：看板聚合结果成10分钟缓存；活动详情可做短生命周期缓存，配合失效策略。

## 五、安全与审计

- 二维码token：包含签名与最小必要信息，避免泄露活动全量信息；服务端解码校验。
- 审计日志：账号变更、活动结束、二维码生成/禁用等必须入审计表；保留期与归档策略明确。
- 数据最小化：评价明细仅发起方可见；县级只能查看本县评价。
- 字段说明：审计日志不包含IP字段，IP信息可从请求上下文获取。

## 六、数据生命周期与归档

- 活动数据：活动结束后保留；评价二维码过期后可归档状态；历史活动打包归档（按季度/年度）。
- 日志数据：审计日志长期保留；系统日志戉7-30天滚动窗口归档至对象存储。
- 软删除策略：所有删除操作均为软删除，通过status设置为deleted，数据永久保留。

## 七、迁移与字典

- 初始迁移脚本：创建所有表、外键与索引；插入县域字典与初始市级管理员。
- 变更策略：通过版本化迁移（如Liquibase/Flyway）管理结构升级。
- 字段命名规范：时间字段统一使用 `_time` 后缀，ID字段统一使用 `_id` 后缀。
# 数据库设计补充（版本 5 对齐）

## 一、数据约束与校验

- 打卡约束：`UNIQUE(activity_id, teaching_point_id)`，保证同一教学点同一活动仅保留最新一次打卡；支持更新覆盖逻辑。
- 评价约束：必须存在该教学点的打卡记录方可评价；可选增强为唯一评价（业务决定）。
- 二维码校验：需同时校验`type`（阶段）、`expire_at`与`status`；过期或禁用均不可用。

## 二、有效期与状态管理

- 打卡二维码：通常与活动进行期绑定；活动结束则置为失效（由服务端控制）。
- 评价二维码：默认有效期7天，可配置；过期后置为`expired`状态。
- 禁用策略：禁用即刻生效；需记录`disabled_at`并写审计日志。

## 三、幂等与防重策略

- 打卡：幂等键为`(activity_id, teaching_point_id)`；以更新覆盖方式实现重复提交一致性。
- 评价：前端防重复提交 + 后端短期窗口限流；如需限制一次评价可加唯一约束。
- 提交令牌：可在二维码token中加入一次性nonce（可选）提升防重能力。

## 四、索引与性能优化

- 高频查询：活动详情页按`activity_id`聚合；看板按状态与时间范围大查询。
- 建议索引：`activities(status, start_time)`、`checkins(activity_id)`、`evaluations(activity_id)`、`qrcodes(activity_id, type, status)`。
- 缓存：看板聚合结果按10分钟缓存；活动详情可做短生命周期缓存，配合失效策略。

## 五、安全与审计

- 二维码token：包含签名与最小必要信息，避免泄露活动全量信息；服务端解码校验。
- 审计日志：账号变更、活动结束、二维码生成/禁用等必须入审计表；保留期与归档策略明确。
- 数据最小化：评价明细仅发起方可见；县级只能查看本县评价。

## 六、数据生命周期与归档

- 活动数据：活动结束后保留；评价二维码过期后可归档状态；历史活动打包归档（按季度/年度）。
- 日志数据：审计日志长期保留；系统日志按7-30天滚动窗口归档至对象存储。

## 七、迁移与字典

- 初始迁移脚本：创建所有表、外键与索引；插入县域字典与初始市级管理员。
- 变更策略：通过版本化迁移（如Liquibase/Knex迁移）管理结构升级。